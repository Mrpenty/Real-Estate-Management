@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Đăng tin mới";
}

<style>
    body {
        background-color: #f8f9fa;
    }
    .form-section {
        background-color: white;
        padding: 2rem;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
    }
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    .form-input, .form-select {
        width: 100%;
        border-radius: 6px;
        border: 1px solid #ced4da;
        padding: 0.75rem 1rem;
    }
    .address-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    .address-modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 2rem;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
</style>

<div class="container mx-auto py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">Tạo tin đăng</h1>
        
        <!-- Step 1 Form -->
        <form id="create-property-form">
            <!-- Property Info -->
            <div class="form-section">
                <h2 class="form-section-title">Thông tin cơ bản</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="title" class="block mb-2 font-medium">Tiêu đề tin đăng</label>
                        <input type="text" id="title" name="title" class="form-input" required>
                    </div>
                    <div>
                        <label for="price" class="block mb-2 font-medium">Giá cho thuê (triệu/tháng)</label>
                        <input type="number" id="price" name="price" class="form-input" required>
                    </div>
                    <div>
                        <label for="area" class="block mb-2 font-medium">Diện tích (m²)</label>
                        <input type="number" id="area" name="area" class="form-input" required>
                    </div>
                    <div>
                        <label for="bedrooms" class="block mb-2 font-medium">Số phòng ngủ</label>
                        <input type="number" id="bedrooms" name="bedrooms" class="form-input" required>
                    </div>
                     <div>
                        <label for="bathrooms" class="block mb-2 font-medium">Số phòng tắm</label>
                        <input type="number" id="bathrooms" name="bathrooms" class="form-input" required>
                    </div>
                    <div>
                        <label for="type" class="block mb-2 font-medium">Loại hình</label>
                        <select id="type" name="type" class="form-select">
                            <option value="Phòng trọ">Phòng trọ</option>
                            <option value="Nhà nguyên căn">Nhà nguyên căn</option>
                            <option value="Căn hộ">Căn hộ</option>
                        </select>
                    </div>
                </div>
                 <div class="mt-4">
                    <label for="description" class="block mb-2 font-medium">Mô tả chi tiết</label>
                    <textarea id="description" name="description" rows="5" class="form-input"></textarea>
                </div>
            </div>

            <!-- Address -->
            <div class="form-section">
                 <h2 class="form-section-title">Địa chỉ</h2>
                 <div class="mb-4">
                    <label for="full-address" class="block text-gray-700 font-bold mb-2">Địa chỉ đầy đủ</label>
                    <input type="text" id="open-address-modal" class="form-input cursor-pointer" placeholder="Bấm để chọn địa chỉ" readonly>
                     <input type="hidden" id="province-id" name="ProvinceId" />
                     <input type="hidden" id="ward-id" name="WardId" />
                     <input type="hidden" id="street-id" name="StreetId" />
                     <input type="hidden" id="street-number" name="StreetNumber" />
                </div>
            </div>

            <!-- Amenities -->
            <div class="form-section">
                <h2 class="form-section-title">Tiện ích</h2>
                <div id="amenities-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    <!-- Amenities will be loaded here by JavaScript -->
                </div>
            </div>
            
            <div class="text-right">
                <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg">Tiếp tục</button>
            </div>
        </form>
    </div>
</div>

<!-- Address Modal -->
<div id="address-modal" class="address-modal">
    <div class="address-modal-content">
        <span class="close-button" id="close-modal-btn">&times;</span>
        <h2 class="text-xl font-bold mb-4">Chọn địa chỉ</h2>
        <div class="space-y-4">
            <div>
                <label class="block mb-2">Tỉnh/Thành</label>
                <select id="province-select" class="form-select"></select>
            </div>
            <div>
                <label class="block mb-2">Phường/Xã</label>
                <select id="ward-select" class="form-select"></select>
            </div>
            <div>
                <label class="block mb-2">Đường</label>
                <select id="street-select" class="form-select"></select>
            </div>
            <div>
                <label class="block mb-2">Số nhà</label>
                <input type="text" id="street-number-input" class="form-input" placeholder="Nhập số nhà">
            </div>
        </div>
        <div class="text-right mt-6">
             <button id="save-address-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Xác nhận</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const apiBaseUrl = 'https://localhost:7031/api';

            // Address Modal
            const modal = $('#address-modal');
            const openModalBtn = $('#open-address-modal');
            const closeModalBtn = $('#close-modal-btn');
            const saveAddressBtn = $('#save-address-btn');

            const provinceSelect = $('#province-select');
            const wardSelect = $('#ward-select');
            const streetSelect = $('#street-select');
            const streetNumberInput = $('#street-number-input');
            const fullAddressInput = $('#open-address-modal');

            openModalBtn.on('click', () => modal.show());
            closeModalBtn.on('click', () => modal.hide());
            $(window).on('click', (event) => {
                if ($(event.target).is(modal)) {
                    modal.hide();
                }
            });

            // Populate Provinces
            $.get(`${apiBaseUrl}/Property/provinces`, function (data) {
                provinceSelect.empty().append('<option value="">Chọn Tỉnh/Thành</option>');
                data.forEach(p => provinceSelect.append(`<option value="${p.id}">${p.name}</option>`));
            });

            // Populate Wards on Province change
            provinceSelect.on('change', function () {
                const provinceId = $(this).val();
                wardSelect.empty().append('<option value="">Chọn Phường/Xã</option>');
                streetSelect.empty().append('<option value="">Chọn Đường</option>');
                if (provinceId) {
                    $.get(`${apiBaseUrl}/Property/wards/${provinceId}`, function (data) {
                        data.forEach(w => wardSelect.append(`<option value="${w.id}">${w.name}</option>`));
                    });
                }
            });

            // Populate Streets on Ward change
            wardSelect.on('change', function () {
                const wardId = $(this).val();
                streetSelect.empty().append('<option value="">Chọn Đường</option>');
                if (wardId) {
                    $.get(`${apiBaseUrl}/Property/streets/${wardId}`, function (data) {
                        data.forEach(s => streetSelect.append(`<option value="${s.id}">${s.name}</option>`));
                    });
                }
            });

            // Save Address
            saveAddressBtn.on('click', function () {
                const provinceName = $('#province-select option:selected').text();
                const wardName = $('#ward-select option:selected').text();
                const streetName = $('#street-select option:selected').text();
                const streetNumber = streetNumberInput.val();
                
                const fullAddress = `${streetNumber} ${streetName}, ${wardName}, ${provinceName}`;
                fullAddressInput.val(fullAddress);

                // Store IDs in hidden fields if your form needs them
                $('#province-id').val(provinceSelect.val());
                $('#ward-id').val(wardSelect.val());
                $('#street-id').val(streetSelect.val());
                $('#street-number').val(streetNumber);

                modal.hide();
            });

            // Populate Amenities
            const amenitiesContainer = $('#amenities-container');
            $.get(`${apiBaseUrl}/Property/amenities`, function (data) {
                data.forEach(amenity => {
                    amenitiesContainer.append(`
                        <div class="flex items-center">
                            <input type="checkbox" name="AmenityIds" value="${amenity.id}" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label class="ml-2 block text-sm text-gray-900">${amenity.name}</label>
                        </div>
                    `);
                });
            });
             // Form submission
            $('#create-property-form').on('submit', function (e) {
                e.preventDefault();

                const formData = {
                    title: $('#title').val(),
                    description: $('#description').val(),
                    price: parseFloat($('#price').val()),
                    area: parseFloat($('#area').val()),
                    bedrooms: parseInt($('#bedrooms').val()),
                    bathrooms: parseInt($('#bathrooms').val()),
                    type: $('#type').val(),
                    location: $('#open-address-modal').val(),
                    amenityIds: $('input[name="AmenityIds"]:checked').map(function () {
                        return parseInt(this.value);
                    }).get(),
                    provinceId: $('#province-id').val(),
                    wardId: $('#ward-id').val(),
                    street: $('#street-number').val() + " " + $('#street-select option:selected').text()
                };

                console.log('Submitting form data:', formData);

                postPropertyService.createProperty(formData)
                    .then(function(response) {
                        console.log('Success:', response);
                        if (response.success) {
                            window.location.href = `/PostProperty/CreateContract/${response.propertyPostId}`;
                        } else {
                            alert('Error creating property: ' + response.message);
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        alert('An error occurred while creating the property. ' + error);
                    });
            });
            
        });
    </script>
}

<script>
    // A simple function in authService to get the token
    // You should place this in your authService.js file
    /*
    getToken() {
        return localStorage.getItem('authToken');
    },
    */
</script> 