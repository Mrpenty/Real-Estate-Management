@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Đăng tin mới";
}

<div class="w-full min-h-screen flex items-center justify-center" style="background-color: #FDF5ED;">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8 mx-auto">
        <h1 class="text-2xl font-bold text-center mb-8">Property Listing Form</h1>
        <form id="create-property-form" class="space-y-8">
            <!-- Basic Information -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="title" class="block text-sm font-medium mb-1">Title *</label>
                        <input type="text" id="title" name="title" class="form-input w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400" placeholder="Enter property title" required>
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium mb-1">Price *</label>
                        <input type="number" id="price" name="price" class="form-input w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400" placeholder="Enter price" required>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="description" class="block text-sm font-medium mb-1">Description *</label>
                    <textarea id="description" name="description" rows="4" class="form-input w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400" placeholder="Describe your property" required></textarea>
                </div>
            </div>

            <!-- Location -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Location</h2>
                <label for="open-address-modal" class="block text-sm font-medium mb-1">Address *</label>
                <input type="text" id="open-address-modal" class="form-input w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400 cursor-pointer" placeholder="Enter property address" readonly required>
                <input type="hidden" id="province-id" name="ProvinceId" />
                <input type="hidden" id="ward-id" name="WardId" />
                <input type="hidden" id="street-id" name="StreetId" />
                <input type="hidden" id="street-number" name="StreetNumber" />
                <div class="mt-4 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center h-32 text-gray-400">
                    <span>Map will appear here</span>
                </div>
            </div>

            <!-- Property Details -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Property Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="type" class="block text-sm font-medium mb-1">Property Type *</label>
                        <select id="type" name="type" class="form-select w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400">
                            <option value="">Select type</option>
                            <option value="Phòng trọ">Phòng trọ</option>
                            <option value="Nhà nguyên căn">Nhà nguyên căn</option>
                            <option value="Căn hộ">Căn hộ</option>
                        </select>
                    </div>
                    <div>
                        <label for="bedrooms" class="block text-sm font-medium mb-1">Number of Rooms *</label>
                        <input type="number" id="bedrooms" name="bedrooms" class="form-input w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400" placeholder="Number of rooms" required>
                    </div>
                    <div>
                        <label for="area" class="block text-sm font-medium mb-1">Area (m²) *</label>
                        <input type="number" id="area" name="area" class="form-input w-full rounded-lg border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-orange-400" placeholder="Property area" required>
                    </div>
                </div>
                <div class="mb-4">
                    <span class="block text-sm font-medium mb-1">Amenities</span>
                    <div id="amenities-container" class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <!-- Amenities will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Images -->
            <div>
                <h2 class="text-lg font-semibold mb-4">Images</h2>
                <div class="mb-4">
                    <label for="image-input" class="block font-semibold mb-2">Ảnh bất động sản</label>
                    <input type="file" id="image-input" name="images" multiple accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" />
                    <input type="hidden" id="primary-image-index" value="0" />
                    <div id="image-preview" class="flex flex-wrap gap-4 mt-4"></div>
                </div>
            </div>

            <!-- Submit -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mt-8">
                <div class="flex flex-col md:flex-row md:items-center gap-2 text-sm">
                    
                    <label class="flex items-center">
                        <input type="checkbox" class="mr-2"> <span>Publish immediately</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" class="mr-2"> <span>Save as draft</span>
                    </label>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0">
                    <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-8 rounded-lg shadow-lg transition duration-300">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Address Modal -->
<div id="address-modal" class="address-modal hidden">
    <div class="address-modal-content">
        <span class="close-button" id="close-modal-btn">&times;</span>
        <h2 class="text-xl font-bold mb-4">Chọn địa chỉ</h2>
        <div class="space-y-4">
            <div>
                <label class="block mb-2">Tỉnh/Thành</label>
                <select id="province-select" class="form-select"></select>
            </div>
            <div>
                <label class="block mb-2">Phường/Xã</label>
                <select id="ward-select" class="form-select"></select>
            </div>
            <div>
                <label class="block mb-2">Đường</label>
                <select id="street-select" class="form-select"></select>
            </div>
            <div>
                <label class="block mb-2">Số nhà</label>
                <input type="text" id="street-number-input" class="form-input" placeholder="Nhập số nhà">
            </div>
        </div>
        <div class="text-right mt-6">
             <button id="save-address-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Xác nhận</button>
        </div>
    </div>
</div>

<style>
.address-modal {
    display: flex;
    align-items: center;
    justify-content: center;
    position: fixed;
    z-index: 50;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0,0,0,0.3);
}
.address-modal.hidden {
    display: none !important;
}
.address-modal-content {
    background-color: #fff;
    border-radius: 12px;
    padding: 2rem;
    min-width: 350px;
    max-width: 600px;
    width: 90vw;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}
.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            const apiBaseUrl = 'https://localhost:7031/api';

            // Address Modal
            const modal = $('#address-modal');
            const openModalBtn = $('#open-address-modal');
            const closeModalBtn = $('#close-modal-btn');
            const saveAddressBtn = $('#save-address-btn');

            const provinceSelect = $('#province-select');
            const wardSelect = $('#ward-select');
            const streetSelect = $('#street-select');
            const streetNumberInput = $('#street-number-input');
            const fullAddressInput = $('#open-address-modal');

            openModalBtn.on('click', () => modal.removeClass('hidden'));
            closeModalBtn.on('click', () => modal.addClass('hidden'));
            $(window).on('click', (event) => {
                if ($(event.target).is(modal)) {
                    modal.addClass('hidden');
                }
            });

            // Populate Provinces
            $.get(`${apiBaseUrl}/Property/provinces`, function (data) {
                provinceSelect.empty().append('<option value="">Chọn Tỉnh/Thành</option>');
                data.forEach(p => provinceSelect.append(`<option value="${p.id}">${p.name}</option>`));
            });

            // Populate Wards on Province change
            provinceSelect.on('change', function () {
                const provinceId = $(this).val();
                wardSelect.empty().append('<option value="">Chọn Phường/Xã</option>');
                streetSelect.empty().append('<option value="">Chọn Đường</option>');
                if (provinceId) {
                    $.get(`${apiBaseUrl}/Property/wards/${provinceId}`, function (data) {
                        data.forEach(w => wardSelect.append(`<option value="${w.id}">${w.name}</option>`));
                    });
                }
            });

            // Populate Streets on Ward change
            wardSelect.on('change', function () {
                const wardId = $(this).val();
                streetSelect.empty().append('<option value="">Chọn Đường</option>');
                if (wardId) {
                    $.get(`${apiBaseUrl}/Property/streets/${wardId}`, function (data) {
                        data.forEach(s => streetSelect.append(`<option value="${s.id}">${s.name}</option>`));
                    });
                }
            });

            // Save Address
            saveAddressBtn.on('click', function () {
                const provinceName = $('#province-select option:selected').text();
                const wardName = $('#ward-select option:selected').text();
                const streetName = $('#street-select option:selected').text();
                const streetNumber = streetNumberInput.val();
                
                const fullAddress = `${streetNumber} ${streetName}, ${wardName}, ${provinceName}`;
                fullAddressInput.val(fullAddress);

                // Store IDs in hidden fields if your form needs them
                $('#province-id').val(provinceSelect.val());
                $('#ward-id').val(wardSelect.val());
                $('#street-id').val(streetSelect.val());
                $('#street-number').val(streetNumber);

                modal.addClass('hidden');
            });

            // Populate Amenities
            const amenitiesContainer = $('#amenities-container');
            $.get(`${apiBaseUrl}/Property/amenities`, function (data) {
                data.forEach(amenity => {
                    amenitiesContainer.append(`
                        <div class="flex items-center">
                            <input type="checkbox" name="AmenityIds" value="${amenity.id}" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label class="ml-2 block text-sm text-gray-900">${amenity.name}</label>
                        </div>
                    `);
                });
            });
             // Form submission
            $('#create-property-form').on('submit', function (e) {
                e.preventDefault();

                const formData = {
                    title: $('#title').val(),
                    description: $('#description').val(),
                    price: parseFloat($('#price').val()),
                    area: parseFloat($('#area').val()),
                    bedrooms: parseInt($('#bedrooms').val()),
                    bathrooms: parseInt($('#bathrooms').val()),
                    type: $('#type').val(),
                    location: $('#open-address-modal').val(),
                    amenityIds: $('input[name="AmenityIds"]:checked').map(function () {
                        return parseInt(this.value);
                    }).get(),
                    provinceId: $('#province-id').val(),
                    wardId: $('#ward-id').val(),
                    street: $('#street-number').val() + " " + $('#street-select option:selected').text()
                };

                console.log('Submitting form data:', formData);

                postPropertyService.createProperty(formData)
                    .then(function(response) {
                        if (response.success) {
                            const propertyId = response.propertyPostId;
                            const imageInput = document.getElementById('image-input');
                            const imageFiles = Array.from(imageInput.files);
                            const primaryImageIndex = parseInt($('#primary-image-index').val());
                            if (imageFiles.length > 0) {
                                uploadImages(propertyId);
                            } else {
                                alert('Đăng tin thành công!');
                                window.location.href = '/';
                            }
                        } else {
                            alert('Error creating property: ' + response.message);
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        alert('An error occurred while creating the property. ' + error);
                    });
            });
            
        });
    </script>
}

<script>
    // A simple function in authService to get the token
    // You should place this in your authService.js file
    /*
    getToken() {
        return localStorage.getItem('authToken');
    },
    */
</script>

<script>
const imageInput = document.getElementById('image-input');
const imagePreview = document.getElementById('image-preview');
const primaryImageIndexInput = document.getElementById('primary-image-index');

let imageFiles = [];
let primaryImageIndex = 0;

imageInput.addEventListener('change', function (e) {
    imageFiles = Array.from(e.target.files);
    primaryImageIndex = 0;
    primaryImageIndexInput.value = 0;
    renderImagePreview();
});

function renderImagePreview() {
    imagePreview.innerHTML = '';
    imageFiles.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = function (e) {
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '120px';
            wrapper.style.height = '120px';
            wrapper.style.border = '1px solid #ddd';
            wrapper.style.borderRadius = '8px';
            wrapper.style.overflow = 'hidden';
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'center';
            wrapper.style.justifyContent = 'center';
            wrapper.style.background = '#fff';

            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'primaryImage';
            radio.value = idx;
            radio.checked = idx === primaryImageIndex;
            radio.style.position = 'absolute';
            radio.style.top = '8px';
            radio.style.right = '8px';
            radio.title = 'Chọn làm ảnh chính';

            radio.addEventListener('change', () => {
                primaryImageIndex = idx;
                primaryImageIndexInput.value = idx;
                renderImagePreview();
            });

            wrapper.appendChild(img);
            wrapper.appendChild(radio);
            imagePreview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
    });
}

// Hàm upload ảnh sau khi tạo property thành công
async function uploadImages(propertyId) {
    await Promise.all(imageFiles.map(async (file, idx) => {
        // TODO: Thay thế đoạn này bằng upload thực tế lên server/storage để lấy url thực tế
        const url = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
        const dto = {
            url: url, // url thực tế sau khi upload
            isPrimary: idx === primaryImageIndex,
            order: idx
        };
        await fetch(`/api/properties/${propertyId}/images`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dto)
        });
    }));
}
</script> 