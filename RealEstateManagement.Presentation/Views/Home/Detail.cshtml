
Ôªø@{
    Layout = "~/Views/Shared/_LayoutV2.cshtml";
}

<link rel="stylesheet" href="~/css/property-detail.css" />

<div class="property-detail-container">
    <div class="property-detail-grid">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Image Gallery -->
            <div class="image-gallery">
                <div class="primary-image-container">
                    <img src="" id="imgPrimaryUrl" onerror="propertyDetailManager.handleImageError(this)" alt="preview" class="primary-image"/>
                </div>
                <div id="listImgs" class="image-thumbnails">
                    <!-- Thumbnails will be populated by JavaScript -->
                </div>
            </div>

            <!-- Content Section -->
            <div class="content-section">
                <div class="property-header">
                    <h1 class="property-title titleId">
                        <!-- Title will be populated by JavaScript -->
                    </h1>
                    <div class="property-rating">
                        <div class="rating-stars">
                            <div class="flex items-center text-gray-500" id="starContainer"></div>
                        </div>
                        <div class="rating-text">
                            <span id="avgStar"></span>
                    </div>
                        <div class="comment-count">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:15px;height:15px" viewBox="0 0 24 24">
                            <path d="M20 2H4C1.8 2 0 3.8 0 6v12c0 2.2 1.8 4 4 4h4v2.4c0 .6.4 1 1 1 .2 0 .5-.1.7-.3L14.3 22H20c2.2 0 4-1.8 4-4V6c0-2.2-1.8-4-4-4z" />
                        </svg>
                            <span><span id="totalCommentCount">0</span> b√¨nh lu·∫≠n</span>
                        </div>
                    </div>
                </div>

                <div class="property-meta">
                    <div class="price-info">
                        <span class="price priceId"></span>
                        <span class="text-black">‚Ä¢</span>
                        <span class="area"><span class="areaId"></span> m¬≤</span>
                    </div>
                    <span class="update-time">C·∫≠p nh·∫≠t: <span class="timeAgoId"></span></span>
                </div>

                <div class="property-details">
                    <div class="detail-item">
                        <span class="detail-label">Qu·∫≠n huy·ªán:</span>
                        <a href="#" class="detail-link wardId"></a>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">T·ªânh th√†nh:</span>
                        <a href="#" class="detail-link provinceId"></a>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">ƒê·ªãa ch·ªâ:</span>
                        <span class="detail-value addressId"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">M√£ tin:</span>
                        <span class="detail-value">#<span id="propId"></span></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ng√†y ƒëƒÉng:</span>
                        <span class="detail-value" id="createTimeId"></span>
                    </div>
                </div>

                <h2 class="section-title">Th√¥ng tin m√¥ t·∫£</h2>
                <div class="description">
                    <p><strong class="titleId"></strong></p>
                    <p>Gi√° thu√™: <span class="priceId"></span>/th√°ng</p>
                    <p>C·ªçc: 1 th√°ng</p>
                    <p class="descriptionId"></p>
                </div>

                <h2 class="section-title">V·ªã tr√≠ & b·∫£n ƒë·ªì</h2>
                <p class="text-sm text-gray-800 block mb-1">
                    <div class="d-none">üìç ƒê·ªãa ch·ªâ: <span class="addressId"></span></div>
                    <a href="#" class="text-orange-600 hover:underline ml-1">Xem b·∫£n ƒë·ªì l·ªõn</a>
                </p>
                <div class="map-container">
                    <iframe id="mapFrame"
                            class="map-frame"
                            allowfullscreen=""
                            loading="lazy"></iframe>
                </div>

                <h2 class="section-title">Th√¥ng tin li√™n h·ªá</h2>
                <div class="contact-section">
                    <div class="contact-avatar" onclick="propertyDetailManager.openLandlord()">
                         <img class="landlordUrl" style="border-radius:5rem;height:100%;width:100%"/>
                    </div>
                    <div class="contact-info">
                        <div class="contact-name" onclick="propertyDetailManager.openLandlord()">
                            <span class="contactName"></span>
                        </div>
                        <div class="contact-actions">
                            <a href="tel:0369864430" class="contact-btn phone">
                                üìû <span class="contactPhone"></span>
                            </a>
                            <a href="#" class="contact-btn zalo">
                                üí¨ Nh·∫Øn Zalo
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Comment and Rating Section -->
                <h2 class="section-title">ƒê√°nh gi√° & B√¨nh lu·∫≠n</h2>
                

                
                <!-- Add Comment Form -->
                <div class="comment-form-section">
                    <div class="comment-form-header">
                        <h3 class="comment-form-title">Th√™m ƒë√°nh gi√° c·ªßa b·∫°n</h3>
                    </div>
                    
                    <form id="commentForm" class="comment-form">
                        <div class="rating-input-section">
                            <label class="rating-label">ƒê√°nh gi√° c·ªßa b·∫°n:</label>
                            <div class="star-rating-input">
                                <input type="radio" id="star5" name="rating" value="5" class="star-input">
                                <label for="star5" class="star-label">‚òÖ</label>
                                <input type="radio" id="star4" name="rating" value="4" class="star-input">
                                <label for="star4" class="star-label">‚òÖ</label>
                                <input type="radio" id="star3" name="rating" value="3" class="star-input">
                                <label for="star3" class="star-label">‚òÖ</label>
                                <input type="radio" id="star2" name="rating" value="2" class="star-input">
                                <label for="star2" class="star-label">‚òÖ</label>
                                <input type="radio" id="star1" name="rating" value="1" class="star-input">
                                <label for="star1" class="star-label">‚òÖ</label>
                            </div>
                        </div>
                        
                        <div class="comment-input-section">
                            <label for="commentContent" class="comment-input-label">B√¨nh lu·∫≠n:</label>
                            <textarea id="commentContent" name="content" rows="4" 
                                      placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ b·∫•t ƒë·ªông s·∫£n n√†y..."
                                      class="comment-textarea" required></textarea>
                        </div>
                        
                        <div class="comment-form-actions">
                            <button type="submit" class="submit-comment-btn">
                                <span>üí¨</span>
                                <span>G·ª≠i ƒë√°nh gi√°</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Comments List -->
                <div class="comments-section">
                    <div class="comments-header">
                        <h3 class="comments-title">T·∫•t c·∫£ ƒë√°nh gi√° (<span id="totalCommentCount">0</span>)</h3>
                    </div>
                    
                    <div id="commentsList" class="comments-list">
                        <!-- Comments will be populated by JavaScript -->
                        <div class="comments-loading">
                            <p class="text-gray-500 text-center py-8">ƒêang t·∫£i b√¨nh lu·∫≠n...</p>
                        </div>
                    </div>
                    
                    <!-- Comments Pagination -->
                    <div id="commentsPagination" class="comments-pagination hidden">
                        <button id="prevComment" class="pagination-btn">‚Äπ Tr∆∞·ªõc</button>
                        <span id="commentPageInfo" class="pagination-info"></span>
                        <button id="nextComment" class="pagination-btn">Sau ‚Ä∫</button>
                    </div>
                    
                    <!-- No Comments Message -->
                    <div id="noComments" class="no-comments hidden">
                        <div class="text-center py-8">
                            <div class="text-gray-400 text-6xl mb-4">üí¨</div>
                            <p class="text-gray-500 text-lg">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</p>
                            <p class="text-gray-400">H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√° b·∫•t ƒë·ªông s·∫£n n√†y!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Properties -->
            <div class="similar-section">
                <div class="similar-header">
                    <h3 class="similar-title">B·∫•t ƒë·ªông s·∫£n t∆∞∆°ng t·ª±</h3>
                        <a id="seeMoreSimilar"
                           href="#"
                       class="see-more-btn"
                           aria-label="Xem th√™m b·∫•t ƒë·ªông s·∫£n t∆∞∆°ng t·ª±">
                            <span class="sr-only">Xem th√™m</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                 class="w-5 h-5 transition-transform transform group-hover:translate-x-0.5">
                                <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </a>
                    </div>

                <div id="similarList" class="similar-grid"></div>
                <div id="similarPager" class="similar-pager hidden">
                    <button id="simPrev" class="pager-btn">‚Äπ Tr∆∞·ªõc</button>
                    <span id="simInfo" class="pager-info"></span>
                    <button id="simNext" class="pager-btn">Sau ‚Ä∫</button>
                </div>
                <div id="similarEmpty" class="similar-empty hidden">Ch∆∞a c√≥ g·ª£i √Ω t∆∞∆°ng t·ª± ph√π h·ª£p.</div>
                            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Contact Card -->
            <div class="sidebar-card contact-card">
                <div class="contact-avatar-large" onclick="propertyDetailManager.openLandlord()">
                    <img class="landlordUrl" style="border-radius:5rem;height:100%;width:100%"/>
                </div>

                <div class="contact-name-large" onclick="propertyDetailManager.openLandlord()">
                    <span class="contactName"></span>
                </div>

                <div class="contact-actions-vertical">
                    <a href="tel:0369864430" id="contactPhone" class="contact-btn-vertical phone">
                        üìû <span class="contactPhone"></span>
                    </a>
                    <a href="javascript:void(0)"
                       @* onclick="startChatWithLandlord(window.landlordId)" *@
                       class="contact-btn zalo">
                        üí¨ Nh·∫Øn Zalo
                    </a>


                </div>

                <div class="action-buttons">
                    <button id="addFavoriteDetail" onclick="propertyDetailManager.addToFavorites()" class="d-none action-btn favorite">
                        <span>‚ô°</span>
                        <span>L∆∞u tin</span>
                    </button>
                    <button id="removeFavoriteDetail" onclick="propertyDetailManager.removeFromFavorites()" class="d-none action-btn favorite">
                        <span>‚ô°</span>
                        <span>B·ªè l∆∞u tin</span>
                    </button>
                    <button class="action-btn">
                        <span>üîó</span>
                        <span>Chia s·∫ª</span>
                    </button>
                    <button id="reportBtn" onclick="propertyDetailManager.openReportModal()" class="action-btn report">
                        <span>‚ö†Ô∏è</span>
                        <span id="reportBtnText">B√°o x·∫•u</span>
                    </button>
                </div>
            </div>

            <!-- News List -->
            <div class="sidebar-card">
                <h3 class="font-semibold text-gray-800 mb-2">Tin m·ªõi ƒëƒÉng</h3>
                <div class="news-list" id="listNew">
                    <!-- News items will be populated by JavaScript -->
        </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white modal-content">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">B√°o c√°o b√†i ƒëƒÉng</h3>
                <button onclick="propertyDetailManager.closeReportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">L√Ω do b√°o c√°o *</label>
                <select id="reportReason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="">Ch·ªçn l√Ω do</option>
                    <option value="Th√¥ng tin sai s·ª± th·∫≠t">Th√¥ng tin sai s·ª± th·∫≠t</option>
                    <option value="H√¨nh ·∫£nh kh√¥ng ƒë√∫ng">H√¨nh ·∫£nh kh√¥ng ƒë√∫ng</option>
                    <option value="Gi√° c·∫£ kh√¥ng ch√≠nh x√°c">Gi√° c·∫£ kh√¥ng ch√≠nh x√°c</option>
                    <option value="ƒê·ªãa ch·ªâ kh√¥ng ƒë√∫ng">ƒê·ªãa ch·ªâ kh√¥ng ƒë√∫ng</option>
                    <option value="N·ªôi dung kh√¥ng ph√π h·ª£p">N·ªôi dung kh√¥ng ph√π h·ª£p</option>
                    <option value="Spam">Spam</option>
                    <option value="Kh√°c">Kh√°c</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£ chi ti·∫øt</label>
                <textarea id="reportDescription" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ v·∫•n ƒë·ªÅ..." 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="propertyDetailManager.closeReportModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    H·ªßy
                </button>
                <button id="submitReportBtn" onclick="propertyDetailManager.submitReport()" 
                        class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                    G·ª≠i b√°o c√°o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Status Modal -->
<div id="reportStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white modal-content">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Tr·∫°ng th√°i b√°o c√°o</h3>
                <button onclick="propertyDetailManager.closeReportStatusModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="reportStatusContent" class="mb-4">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <div class="flex justify-end">
                <button onclick="propertyDetailManager.closeReportStatusModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

@* <script>
    function getUserIdFromToken(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const id = payload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"]
                || payload["sub"]
                || payload["nameid"];
            return parseInt(id);
        } catch {
            return null;
        }
    }
</script> *@

<script>
    // Set the current property ID from ViewBag
    window.currentPropertyId = @ViewBag.Id;
    
    // Debug logging
    console.log('ViewBag.Id:', @ViewBag.Id);
    console.log('window.currentPropertyId:', window.currentPropertyId);
    
    // Ensure the ID is valid
    if (!window.currentPropertyId || window.currentPropertyId === 0) {
        console.error('Invalid property ID:', window.currentPropertyId);
        // Try to extract from URL as fallback
        const pathParts = window.location.pathname.split('/');
        const idIndex = pathParts.indexOf('Detail');
        if (idIndex !== -1 && pathParts[idIndex + 1]) {
            window.currentPropertyId = pathParts[idIndex + 1];
            console.log('Extracted ID from URL:', window.currentPropertyId);
        }
    }

     
    function getUserIdFromToken(token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const id = payload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"]
                || payload["sub"] || payload["nameid"];
            return Number(id);
        } catch {
            return NaN;
        }
    }

    async function startChatWithLandlord(landlordIdRaw, propertyIdRaw) {
        const token = localStorage.getItem("authToken");
        if (!token) { window.location.href = "/Auth/Login"; return; }

        // √âp ki·ªÉu/ch·ªët d·ªØ li·ªáu ch·∫Øc ch·∫Øn l√† number
        const renterId = getUserIdFromToken(token);
        const landlordId = Number(landlordIdRaw);
        const propertyIdNum = Number(propertyIdRaw);

        if (!Number.isFinite(renterId)) { alert("Token kh√¥ng h·ª£p l·ªá, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i."); return; }
        if (!Number.isFinite(landlordId)) { alert("Thi·∫øu ho·∫∑c sai landlordId."); return; }

        // X√¢y body: KH√îNG ƒë∆∞a propertyId n·∫øu kh√¥ng c√≥ s·ªë h·ª£p l·ªá
        const dto = {
            renterId: renterId,
            landlordId: landlordId
            // propertyId ch·ªâ th√™m khi h·ª£p l·ªá
        };
        if (Number.isFinite(propertyIdNum) && propertyIdNum > 0) {
            dto.propertyId = propertyIdNum;
        }

        try {
            const res = await fetch("http://194.233.81.64:5000/api/Chat/Create-Conversation", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(dto) // JSON.stringify s·∫Ω b·ªè qua field undefined
            });

            if (!res.ok) {
                const errText = await res.text();
                alert("Kh√¥ng th·ªÉ m·ªü cu·ªôc tr√≤ chuy·ªán: " + errText);
                return;
            }

            const data = await res.json(); // { id: ... }
            if (data && data.id) {
                window.location.href = `/Chat/Index?conversationId=${data.id}`;
            }
        } catch (err) {
            console.error("L·ªói khi m·ªü chat:", err);
            alert("L·ªói khi m·ªü chat: " + err);
        }
    }


</script>
<script src="~/js/helper.js"></script>
<script src="~/js/Home/reportService.js"></script>
<script src="~/js/propertyService.js"></script>
<script src="~/js/Home/review.js"></script>
<script src="~/js/Home/property-detail.js"></script>
