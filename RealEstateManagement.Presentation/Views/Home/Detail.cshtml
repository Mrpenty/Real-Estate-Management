@{
Layout = "~/Views/Shared/_LayoutV2.cshtml";
}

<link rel="stylesheet" href="~/css/property-detail.css" />
<style>

    }

    /* Button */
    .interest-btn {
        margin-top: 10px;
        padding: 10px 20px;
        background: #ff5722;
        color: white;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

        .interest-btn:hover {
            background: #e64a19;
        }

</style>
<div class="property-detail-container">
    <div class="property-detail-grid">
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Image Gallery -->
            <div class="image-gallery">
                <div class="primary-image-container">
                    <img src="" id="imgPrimaryUrl" onerror="propertyDetailManager.handleImageError(this)" alt="preview" class="primary-image" />
                </div>
                <div id="listImgs" class="image-thumbnails">
                    <!-- Thumbnails will be populated by JavaScript -->
                </div>
            </div>

            <!-- Content Section -->
            <div class="content-section">
                <div class="property-header">
                    <h1 class="property-title titleId">
                        <!-- Title will be populated by JavaScript -->
                    </h1>
                    <div class="property-rating">
                        <div class="rating-stars">
                            <div class="flex items-center text-gray-500" id="starContainer"></div>
                        </div>
                        <div class="rating-text">
                            <span id="avgStar"></span>
                        </div>
                        <div class="comment-count">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:15px;height:15px" viewBox="0 0 24 24">
                                <path d="M20 2H4C1.8 2 0 3.8 0 6v12c0 2.2 1.8 4 4 4h4v2.4c0 .6.4 1 1 1 .2 0 .5-.1.7-.3L14.3 22H20c2.2 0 4-1.8 4-4V6c0-2.2-1.8-4-4-4z" />
                            </svg>
                            <span><span id="totalCommentCount">0</span> bình luận</span>
                        </div>
                    </div>
                </div>

                <div class="property-meta">
                    <div class="price-info">
                        <span class="price priceId"></span>
                        <span class="text-black">•</span>
                        <span class="area"><span class="areaId"></span> m²</span>
                    </div>
                    <span class="update-time">Cập nhật: <span class="timeAgoId"></span></span>
                </div>

                <div class="property-details">
                    <div class="detail-item">
                        <span class="detail-label">Quận huyện:</span>
                        <a href="#" class="detail-link wardId"></a>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Tỉnh thành:</span>
                        <a href="#" class="detail-link provinceId"></a>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Địa chỉ:</span>
                        <span class="detail-value addressId"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Mã tin:</span>
                        <span class="detail-value">#<span id="propId"></span></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Ngày đăng:</span>
                        <span class="detail-value" id="createTimeId"></span>
                    </div>
                </div>

                <h2 class="section-title">Thông tin mô tả</h2>
                <div class="description">
                    <p><strong class="titleId"></strong></p>
                    <p>Giá thuê: <span class="priceId"></span>/tháng</p>
                    <p>Cọc: 1 tháng</p>
                    <p class="descriptionId"></p>
                </div>

                <h2 class="section-title">Vị trí & bản đồ</h2>
                <p class="text-sm text-gray-800 block mb-1">
                    <div class="d-none">📍 Địa chỉ: <span class="addressId"></span></div>
                    <a href="#" class="text-orange-600 hover:underline ml-1">Xem bản đồ lớn</a>
                </p>
                <div class="map-container">
                    <iframe id="mapFrame"
                            class="map-frame"
                            allowfullscreen=""
                            loading="lazy"></iframe>
                </div>

                <!-- Interest Section -->
                <h2 class="section-title">Quan tâm bài đăng</h2>
                <div class="interest-section">
                    <p class="interest-note">
                        <span class="arrow">➤</span>
                        Để liên hệ với người thuê và xem chi tiết hợp đồng, hãy ấn nút <strong>Quan tâm</strong>
                    </p>
                    <button class="interest-btn btn-add-interest">
                        ❤️ Quan tâm
                    </button>
                    <button class="interest-btn btn-remove-interest" style="display:none;">
                        ❌ Hủy quan tâm
                    </button>
                    <button class="interest-btn btn-view-contract" style="display:none;">
                        📄 Xem hợp đồng
                    </button>
                    <button class="interest-btn btn-success btn-agree-rent" style="display:none;">
                        Tôi muốn thuê
                    </button>
                    <div class="waiting-landlord text-warning" style="display:none;"></div>
                </div>

                <!-- Khung hiển thị hợp đồng -->
                <div id="contract-section" style="display:none; margin-top:15px; border:1px solid #ccc; padding:10px; border-radius:6px;">
                    <h2 class="section-title">📄 Thông tin hợp đồng</h2>
                    <table style="width:100%; border-collapse: collapse;">
                        <tbody>
                            <tr><td><strong>Tiền cọc:</strong></td><td id="ContractDeposit"></td></tr>
                            <tr><td><strong>Tiền thuê hàng tháng:</strong></td><td id="ContractMonthlyRent"></td></tr>
                            <tr><td><strong>Thời hạn hợp đồng (tháng):</strong></td><td id="ContractDurationMonths"></td></tr>
                            <tr><td><strong>Ngày bắt đầu:</strong></td><td id="ContractStartDate"></td></tr>
                            <tr><td><strong>Ngày kết thúc:</strong></td><td id="ContractEndDate"></td></tr>
                            <tr><td><strong>Trạng thái:</strong></td><td id="ContractStatus"></td></tr>
                            <tr><td><strong>Phương thức thanh toán:</strong></td><td id="ContractPaymentMethod"></td></tr>
                            <tr><td><strong>Thông tin liên hệ:</strong></td><td id="ContractContactInfo"></td></tr>
                        </tbody>
                    </table>
                </div>

                
                <h2 class="section-title">Thông tin liên hệ</h2>
                <div class="contact-section">
                    <div class="contact-avatar" onclick="propertyDetailManager.openLandlord()">
                        <img class="landlordUrl" style="border-radius:5rem;height:100%;width:100%" />
                    </div>
                    <div class="contact-info">
                        <div class="contact-name" onclick="propertyDetailManager.openLandlord()">
                            <span class="contactName"></span>
                        </div>
                        <div class="contact-actions">
                            <a href="tel:0369864430" class="contact-btn phone">
                                📞 <span class="contactPhone"></span>
                            </a>
                            <a href="#" class="contact-btn zalo">
                                💬 Nhắn Zalo
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Comment and Rating Section -->
                <h2 class="section-title">Đánh giá & Bình luận</h2>



                <!-- Add Comment Form -->
                <div class="comment-form-section">
                    <div class="comment-form-header">
                        <h3 class="comment-form-title">Thêm đánh giá của bạn</h3>
                    </div>

                    <form id="commentForm" class="comment-form">
                        <div class="rating-input-section">
                            <label class="rating-label">Đánh giá của bạn:</label>
                            <div class="star-rating-input">
                                <input type="radio" id="star1" name="rating" value="1" class="star-input">
                                <label for="star1" class="star-label">★</label>
                                <input type="radio" id="star2" name="rating" value="2" class="star-input">
                                <label for="star2" class="star-label">★</label>
                                <input type="radio" id="star3" name="rating" value="3" class="star-input">
                                <label for="star3" class="star-label">★</label>
                                <input type="radio" id="star4" name="rating" value="4" class="star-input">
                                <label for="star4" class="star-label">★</label>
                                <input type="radio" id="star5" name="rating" value="5" class="star-input">
                                <label for="star5" class="star-label">★</label>
                            </div>
                        </div>

                        <div class="comment-input-section">
                            <label for="commentContent" class="comment-input-label">Bình luận:</label>
                            <textarea id="commentContent" name="content" rows="4"
                                      placeholder="Chia sẻ trải nghiệm của bạn về bất động sản này..."
                                      class="comment-textarea" required></textarea>
                        </div>

                        <div class="comment-form-actions">
                            <button type="submit" class="submit-comment-btn">
                                <span>💬</span>
                                <span>Gửi đánh giá</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Comments List -->
                <div class="comments-section">
                    <div class="comments-header">
                        <h3 class="comments-title">Tất cả đánh giá (<span id="totalCommentCount1">0</span>)</h3>
                    </div>

                    <div id="commentsList" class="comments-list">
                        <!-- Comments will be populated by JavaScript -->
                        <div class="comments-loading">
                            <p class="text-gray-500 text-center py-8">Đang tải bình luận...</p>
                        </div>
                    </div>

                    <!-- Comments Pagination -->
                    <div id="commentsPagination" class="comments-pagination hidden">
                        <button id="prevComment" class="pagination-btn">‹ Trước</button>
                        <span id="commentPageInfo" class="pagination-info"></span>
                        <button id="nextComment" class="pagination-btn">Sau ›</button>
                    </div>

                    <!-- No Comments Message -->
                    <div id="noComments" class="no-comments hidden">
                        <div class="text-center py-8">
                            <div class="text-gray-400 text-6xl mb-4">💬</div>
                            <p class="text-gray-500 text-lg">Chưa có đánh giá nào</p>
                            <p class="text-gray-400">Hãy là người đầu tiên đánh giá bất động sản này!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Similar Properties -->
            <div class="similar-section">
                <div class="similar-header">
                    <h3 class="similar-title">Bất động sản tương tự</h3>
                    <a id="seeMoreSimilar"
                       href="#"
                       class="see-more-btn"
                       aria-label="Xem thêm bất động sản tương tự">
                        <span class="sr-only">Xem thêm</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                             class="w-5 h-5 transition-transform transform group-hover:translate-x-0.5">
                            <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </a>
                </div>

                <div id="similarList" class="similar-grid"></div>
                <div id="similarPager" class="similar-pager hidden">
                    <button id="simPrev" class="pager-btn">‹ Trước</button>
                    <span id="simInfo" class="pager-info"></span>
                    <button id="simNext" class="pager-btn">Sau ›</button>
                </div>
                <div id="similarEmpty" class="similar-empty hidden">Chưa có gợi ý tương tự phù hợp.</div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Contact Card -->
            <div class="sidebar-card contact-card">
                <div class="contact-avatar-large" onclick="propertyDetailManager.openLandlord()">
                    <img class="landlordUrl" style="border-radius:5rem;height:100%;width:100%" />
                </div>

                <div class="contact-name-large" onclick="propertyDetailManager.openLandlord()">
                    <span class="contactName"></span>
                </div>

                <div class="contact-actions-vertical">
                    <a href="tel:0369864430" id="contactPhone" class="contact-btn-vertical phone">
                        📞 <span class="contactPhone"></span>
                    </a>
                    <a href="#" class="contact-btn-vertical zalo">
                        💬 Nhắn Zalo
                    </a>
                </div>

                <div class="action-buttons">
                    <button id="addFavoriteDetail" onclick="propertyDetailManager.addToFavorites()" class="d-none action-btn favorite">
                        <span>♡</span>
                        <span>Lưu tin</span>
                    </button>
                    <button id="removeFavoriteDetail" onclick="propertyDetailManager.removeFromFavorites()" class="d-none action-btn favorite">
                        <span>♡</span>
                        <span>Bỏ lưu tin</span>
                    </button>
                    <button class="action-btn">
                        <span>🔗</span>
                        <span>Chia sẻ</span>
                    </button>
                    <button id="reportBtn" onclick="propertyDetailManager.openReportModal()" class="action-btn report">
                        <span>⚠️</span>
                        <span id="reportBtnText">Báo xấu</span>
                    </button>
                </div>
            </div>

            <!-- News List -->
            <div class="sidebar-card">
                <h3 class="font-semibold text-gray-800 mb-2">Tin mới đăng</h3>
                <div class="news-list" id="listNew">
                    <!-- News items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white modal-content">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Báo cáo bài đăng</h3>
                <button onclick="propertyDetailManager.closeReportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Lý do báo cáo *</label>
                <select id="reportReason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <option value="">Chọn lý do</option>
                    <option value="Thông tin sai sự thật">Thông tin sai sự thật</option>
                    <option value="Hình ảnh không đúng">Hình ảnh không đúng</option>
                    <option value="Giá cả không chính xác">Giá cả không chính xác</option>
                    <option value="Địa chỉ không đúng">Địa chỉ không đúng</option>
                    <option value="Nội dung không phù hợp">Nội dung không phù hợp</option>
                    <option value="Spam">Spam</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả chi tiết</label>
                <textarea id="reportDescription" rows="3" placeholder="Mô tả chi tiết về vấn đề..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="propertyDetailManager.closeReportModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    Hủy
                </button>
                <button id="submitReportBtn" onclick="propertyDetailManager.submitReport()"
                        class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                    Gửi báo cáo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Status Modal -->
<div id="reportStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 modal-overlay">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white modal-content">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Trạng thái báo cáo</h3>
                <button onclick="propertyDetailManager.closeReportStatusModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="reportStatusContent" class="mb-4">
                <!-- Content will be populated by JavaScript -->
            </div>

            <div class="flex justify-end">
                <button onclick="propertyDetailManager.closeReportStatusModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>


<script>
    // Set the current property ID from ViewBag
    window.currentPropertyId = @ViewBag.Id;

    // Debug logging
    console.log('ViewBag.Id:', @ViewBag.Id);
    console.log('window.currentPropertyId:', window.currentPropertyId);

    // Ensure the ID is valid
    if (!window.currentPropertyId || window.currentPropertyId === 0) {
        console.error('Invalid property ID:', window.currentPropertyId);
        // Try to extract from URL as fallback
        const pathParts = window.location.pathname.split('/');
        const idIndex = pathParts.indexOf('Detail');
        if (idIndex !== -1 && pathParts[idIndex + 1]) {
            window.currentPropertyId = pathParts[idIndex + 1];
            console.log('Extracted ID from URL:', window.currentPropertyId);
        }
    }

</script>
<script src="~/js/helper.js"></script>
<script src="~/js/Home/reportService.js"></script>
<script src="~/js/propertyService.js"></script>
<script src="~/js/Home/review.js"></script>
<script src="~/js/Home/property-detail.js"></script>
