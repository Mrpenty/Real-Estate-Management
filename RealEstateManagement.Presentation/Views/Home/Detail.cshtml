
Ôªø@{
    // ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_LayoutV2.cshtml";
}
<style>
    .text-orange-500 {
        color: rgb(249 115 22 / var(--tw-text-opacity, 1)) !important;
    }

    .d-none{
        display:none;
    }

    .imgDetail{
        cursor:pointer;
    }

    a {
        color: black !important;
    }

        a:hover {
            color: rgb(249 115 22 / var(--tw-text-opacity, 1)) !important;
            border-color: rgb(249 115 22 / var(--tw-border-opacity, 1));
        }
</style>
@* <h1 class="text-xl font-bold mb-4">K√™nh th√¥ng tin Ph√≤ng Tr·ªç s·ªë 1 Vi·ªát Nam</h1> *@
@* <nav class="text-sm text-blue-600 space-x-1 mb-2">
    <a href="#" class="hover:underline">Cho thu√™ ph√≤ng tr·ªç</a> /
    <a href="#" class="hover:underline">H·ªì Ch√≠ Minh</a> /
    <a href="#" class="hover:underline">Qu·∫≠n 7</a> /
    <span class="text-gray-700">Pass ph√≤ng c·ª≠a s·ªï l·ªõn 175 Nguy·ªÖn Th·ªã Th·∫≠p</span>
</nav> *@

<div class="grid grid-cols-1 md:grid-cols-3 gap-6" style="margin-top:2rem">

    <div class="md:col-span-2">
        <div class="grid gap-6">
            <div class="bg-white rounded-md shadow-sm p-4">
                <div class="relative aspect-video w-full bg-white rounded-md overflow-hidden">
                    <img src="" id="imgPrimaryUrl" onerror="handleImageError(this)" alt="preview" class="object-cover w-full h-full"/>
@*                     <div class="absolute bottom-2 left-2 text-white text-xs bg-black/70 px-2 py-1 rounded">0:00 / 0:34</div> *@
                </div>

                <div id="listImgs" class="flex space-x-2 mt-4 overflow-x-auto">
@*                     <div class="border-2 border-red-500 rounded p-1">
                        <img src="https://pt123.cdn.static123.com/images/thumbs/900x600/fit/2025/06/19/2_1750340748.jpg" class="w-20 h-16 object-cover" />
                    </div>
                    <img src="https://pt123.cdn.static123.com/images/thumbs/900x600/fit/2025/06/19/2_1750340748.jpg" class="w-20 h-16 object-cover rounded" /> *@
                </div>
            </div>

            <div class="bg-white rounded-md shadow-sm p-4">
@*                 <div class="flex items-center space-x-2 mb-2">
                    <span class="text-yellow-500 text-lg font-bold">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                    <span class="bg-red-500 text-white text-xs px-2 py-1 rounded uppercase font-semibold">Tin VIP N·ªïi B·∫≠t</span>
                </div> *@
                <div class="flex">
                    <h1 class="text-xl font-bold text-red-600 titleId">
                    </h1>
                    <div class="flex items-center">
                        <div class="flex items-center text-gray-500 ml-2"><span id="avgStar"></span></div>
                        <div style="margin-bottom:2px" class="flex items-center text-yellow-500 ml-2" id="starContainer"></div>
                    </div>
                    

                    <div class="flex items-center text-gray-600 ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" style="width:15px;height:15px" viewBox="0 0 24 24">
                            <path d="M20 2H4C1.8 2 0 3.8 0 6v12c0 2.2 1.8 4 4 4h4v2.4c0 .6.4 1 1 1 .2 0 .5-.1.7-.3L14.3 22H20c2.2 0 4-1.8 4-4V6c0-2.2-1.8-4-4-4z" />
                        </svg>
                        <span class="ml-1"><span id ="totalComment"></span><span> b√¨nh lu·∫≠n</span></span>
                    </div>
                </div>

                <div class="flex items-center text-green-600 font-semibold text-lg space-x-2">
                    <span class="priceId"></span>
                    <span class="text-black font-normal">‚Ä¢</span>
                    <span class="text-gray-700 text-base"><span class="areaId"></span> m¬≤</span>
                    <span class="ml-auto text-sm text-gray-500">C·∫≠p nh·∫≠t: <span class="timeAgoId"></span></span>
                </div>
                <div class="text-sm text-gray-800 space-y-1">
                    <p><span class="font-medium text-gray-600">Qu·∫≠n huy·ªán:</span> <a href="#" class="text-blue-600 hover:underline wardId" ></a></p>
                    <p><span class="font-medium text-gray-600">T·ªânh th√†nh:</span> <a href="#" class="text-blue-600 hover:underline provinceId" ></a></p>
                    <p><span class="font-medium text-gray-600">ƒê·ªãa ch·ªâ:</span> <span class="addressId"></span></p>
                    <p><span class="font-medium text-gray-600">M√£ tin:</span> #<span id="propId"></span></p>
                    <p><span class="font-medium text-gray-600">Ng√†y ƒëƒÉng:</span> <span id="createTimeId"></span></p>
                </div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2 mt-3">Th√¥ng tin m√¥ t·∫£</h2>
                <div class="text-sm text-gray-800 space-y-2 leading-relaxed">
                    <p><strong class="titleId"></strong></p>
                    <p>Gi√° thu√™: <span class="priceId"></span>/th√°ng</p>
                    <p>C·ªçc: 1 th√°ng</p>
                    <p class="descriptionId"></p>
                </div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2 mt-3">V·ªã tr√≠ & b·∫£n ƒë·ªì</h2>
                <p class="text-sm text-gray-800 block mb-1">
                    <div class="d-none">üìç ƒê·ªãa ch·ªâ: <span class="addressId"></span></div>
                    <a href="#" class="text-blue-600 hover:underline ml-1">Xem b·∫£n ƒë·ªì l·ªõn</a>
                </p>
                <div class="w-full h-64 rounded overflow-hidden border">
                    <iframe id="mapFrame"
                            class="w-full h-full"
                            style="border:0"
                            allowfullscreen=""
                            loading="lazy"></iframe>
                </div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2 mt-3">Th√¥ng tin li√™n h·ªá</h2>
                <div class="flex items-start space-x-4">
                    <div style="cursor:pointer" onclick="openLandlord()" class="w-14 h-14 bg-gray-200 rounded-full flex-shrink-0">
                         <img class="landlordUrl" style="border-radius:5rem;height:100%;width:100%"/>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            <p style="cursor:pointer" onclick="openLandlord()" class="font-semibold text-gray-800 contactName"></p>
                            <span style="display:none" class="text-green-600 text-xs font-medium">‚óè ƒêang ho·∫°t ƒë·ªông</span>
                        </div>
                        <p style="display:none" class="text-sm text-gray-500">1 tin ƒëƒÉng ‚Ä¢ Tham gia t·ª´: 19/06/2025</p>
                        <div class="flex space-x-2 mt-2">
                            <a href="tel:0369864430" class="bg-green-500 text-white px-4 py-2 rounded text-sm font-medium hover:bg-green-600">
                                üìû <span class="contactPhone"></span>
                            </a>
                            <a href="#" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700">
                                üí¨ Nh·∫Øn Zalo
                            </a>
                        </div>
                    </div>
            </div>
                <!-- B·∫•t ƒë·ªông s·∫£n t∆∞∆°ng t·ª± -->
                <div class="mt-8 bg-white rounded-md shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-800">B·∫•t ƒë·ªông s·∫£n t∆∞∆°ng t·ª±</h3>
                        <a id="seeMoreSimilar"
                           href="#"
                           class="hidden group inline-flex items-center justify-center w-9 h-9 rounded-full border border-gray-300 text-gray-600
          hover:text-orange-500 hover:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-400"
                           aria-label="Xem th√™m b·∫•t ƒë·ªông s·∫£n t∆∞∆°ng t·ª±">
                            <span class="sr-only">Xem th√™m</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                 class="w-5 h-5 transition-transform transform group-hover:translate-x-0.5">
                                <path d="M9 6l6 6-6 6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </a>

                    </div>

                    <div id="similarList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    <div id="similarPager" class="flex items-center justify-center gap-3 mt-3 hidden">
                        <button id="simPrev"
                                class="px-3 py-1 border rounded hover:border-orange-500 hover:text-orange-500">
                            ‚Äπ Tr∆∞·ªõc
                        </button>
                        <span id="simInfo" class="text-sm text-gray-600"></span>
                        <button id="simNext"
                                class="px-3 py-1 border rounded hover:border-orange-500 hover:text-orange-500">
                            Sau ‚Ä∫
                        </button>
                    </div>
                    <div id="similarEmpty" class="text-sm text-gray-500 mt-3 hidden">Ch∆∞a c√≥ g·ª£i √Ω t∆∞∆°ng t·ª± ph√π h·ª£p.</div>
                </div>

                <script>
                    let simPage = 1;
                    let simPageSize = 3; // ƒëang test th√¨ ƒë·ªÉ 1‚Äì3 tu·ª≥ b·∫°n
                    let simTotalItems = 0;
                    let simTotalPages = 1;

                    async function loadSimilar(page = 1) {
                        try {
                            simPage = Math.max(1, page);

                            const res = await fetch(`${urlBase}/api/Property/${@ViewBag.Id}/similar?page=${simPage}&pageSize=${simPageSize}`, {
                                headers: { 'Accept': 'application/json' }
                            });
                            if (!res.ok) throw new Error('Similar API failed');

                            // K·ª≥ v·ªçng d·∫°ng tr·∫£ v·ªÅ t·ª´ service:
                            // { page, pageSize, totalItems, items: [...] }
                            const data = await res.json();

                            const items = data.items || [];
                            simPage = data.page || simPage;
                            simPageSize = data.pageSize || simPageSize;
                            simTotalItems = data.totalItems || 0;
                            simTotalPages = Math.max(1, Math.ceil(simTotalItems / simPageSize));

                            const wrap = document.getElementById('similarList');
                            const empty = document.getElementById('similarEmpty');
                            const pager = document.getElementById('similarPager');

                            if (!items.length) {
                                wrap.innerHTML = '';
                                empty.classList.remove('hidden');
                                pager.classList.add('hidden');
                                return;
                            }

                            empty.classList.add('hidden');
                            wrap.innerHTML = items.map(renderSimilarCard).join('');

                            // ‚ÄúXem th√™m‚Äù link (n·∫øu b·∫°n v·∫´n mu·ªën hi·ªán)
                            const more = document.getElementById('seeMoreSimilar');
                            if (more && items[0]?.type) {
                                more.href = `/Home/Search?type=${encodeURIComponent(items[0].type)}`;
                                more.classList.remove('hidden');
                            }

                            // C·∫≠p nh·∫≠t pager
                            document.getElementById('simInfo').textContent =
                                `Trang ${simPage}/${simTotalPages} ‚Ä¢ ${simTotalItems} tin`;

                            const prev = document.getElementById('simPrev');
                            const next = document.getElementById('simNext');
                            prev.disabled = (simPage <= 1);
                            next.disabled = (simPage >= simTotalPages);

                            pager.classList.remove('hidden');

                            // g·∫Øn handler 1 l·∫ßn
                            if (!prev._bound) {
                                prev.addEventListener('click', () => loadSimilar(simPage - 1));
                                prev._bound = true;
                            }
                            if (!next._bound) {
                                next.addEventListener('click', () => loadSimilar(simPage + 1));
                                next._bound = true;
                            }
                        } catch (e) {
                            console.error(e);
                            document.getElementById('similarEmpty').classList.remove('hidden');
                            document.getElementById('similarPager').classList.add('hidden');
                        }
                    }

                    function renderSimilarCard(p) {
                        const img = p.primaryImageUrl
                            ? (p.primaryImageUrl.startsWith('http') ? p.primaryImageUrl : `${urlBase}${p.primaryImageUrl}`)
                            : '/image/default-property.jpg';
                        const address = [p.street, p.ward, p.province].filter(Boolean).join(', ');
                        const priceText = (typeof formatVietnameseNumber === 'function')
                            ? `${formatVietnameseNumber(p.price)} ƒë`
                            : `${(p.price ?? 0).toLocaleString('vi-VN')} ƒë`;

                        return `
                          <div class="border rounded-md overflow-hidden hover:shadow transition cursor-pointer"
                               onclick="window.location.href='/Home/Detail/${p.id}'">
                            <div class="aspect-video bg-gray-100">
                              <img src="${img}" onerror="handleImageError(this)" class="w-full h-full object-cover"/>
                            </div>
                            <div class="p-3">
                              <h4 class="font-semibold text-gray-900 line-clamp-2">${escapeHtml(p.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ')}</h4>
                              <div class="mt-1 text-green-600 font-semibold">${priceText}</div>
                              <div class="text-sm text-gray-600">${p.area} m¬≤ ¬∑ ${p.bedrooms} ph√≤ng</div>
                              <div class="text-xs text-gray-500 mt-1 line-clamp-1">${escapeHtml(address)}</div>
                            </div>
                          </div>`;
                    }

                    function escapeHtml(s) {
                        return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
                    }

                    document.addEventListener('DOMContentLoaded', () => loadSimilar(1));
                </script>


        </div>
    </div>
    </div>
    <div>
        <div style="height: max-content;" class="w-full max-w-xs bg-white p-4 rounded-md shadow-sm space-y-4 text-sm">
            <div class="space-y-4 text-center">
                <div style="cursor:pointer" onclick="openLandlord()" class="w-20 h-20 mx-auto rounded-full border bg-gray-100 flex items-center justify-center">
                    <img class="landlordUrl" style="border-radius:5rem;height:100%;width:100%"/>
                </div>

                <div>
                    <p style="cursor:pointer" onclick="openLandlord()" class="font-semibold text-gray-800 contactName"></p>
                    <p style="display:none" class="text-sm text-gray-500">
                        <span class="text-green-500">‚óè</span> ƒêang ho·∫°t ƒë·ªông
                    </p>
                </div>

                <p style="display:none" class="text-sm text-gray-500">1 tin ƒëƒÉng ‚Ä¢ Tham gia t·ª´: 19/06/2025</p>

                <div class="space-y-2">
                    <a href="tel:0369864430" id="contactPhone" class="block w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-semibold">
                        üìû <span class="contactPhone"></span>
                    </a>
                    <a href="#" class="block w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">
                        üí¨ Nh·∫Øn Zalo
                    </a>
                </div>

                <div class="flex justify-around text-sm text-gray-600 pt-2 border-t">
                    <button id="addFavoriteDetail" onclick="addToFavourite(@ViewBag.Id);" class="d-none flex items-center space-x-1 hover:text-blue-600">
                        <span>‚ô°</span><span>L∆∞u tin</span>
                    </button>
                    <button id="removeFavoriteDetail" onclick="removeToFavorite(@ViewBag.Id);" style="color:red" class="d-none flex items-center space-x-1 hover:text-blue-600">
                        <span>‚ô°</span><span>B·ªè l∆∞u tin</span>
                    </button>
                    <button class="flex items-center space-x-1 hover:text-blue-600">
                        <span>üîó</span><span>Chia s·∫ª</span>
                    </button>
                    <button id="reportBtn" onclick="openReportModal()" class="flex items-center space-x-1 hover:text-red-500 px-3 py-1 rounded transition-colors">
                        <span>‚ö†Ô∏è</span><span id="reportBtnText">B√°o x·∫•u</span>
                    </button>
                </div>
            </div>
        </div>
        <div style="height: max-content;" class="w-full mt-4 max-w-xs bg-white p-4 rounded-md shadow-sm space-y-4 text-sm">
            <h3 class="font-semibold text-gray-800 mb-2">Tin m·ªõi ƒëƒÉng</h3>
            <div class="space-y-4" id="listNew">
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">B√°o c√°o b√†i ƒëƒÉng</h3>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">L√Ω do b√°o c√°o *</label>
                <select id="reportReason" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                    <option value="">Ch·ªçn l√Ω do</option>
                    <option value="Th√¥ng tin sai s·ª± th·∫≠t">Th√¥ng tin sai s·ª± th·∫≠t</option>
                    <option value="H√¨nh ·∫£nh kh√¥ng ƒë√∫ng">H√¨nh ·∫£nh kh√¥ng ƒë√∫ng</option>
                    <option value="Gi√° c·∫£ kh√¥ng ch√≠nh x√°c">Gi√° c·∫£ kh√¥ng ch√≠nh x√°c</option>
                    <option value="ƒê·ªãa ch·ªâ kh√¥ng ƒë√∫ng">ƒê·ªãa ch·ªâ kh√¥ng ƒë√∫ng</option>
                    <option value="N·ªôi dung kh√¥ng ph√π h·ª£p">N·ªôi dung kh√¥ng ph√π h·ª£p</option>
                    <option value="Spam">Spam</option>
                    <option value="Kh√°c">Kh√°c</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">M√¥ t·∫£ chi ti·∫øt</label>
                <textarea id="reportDescription" rows="3" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ v·∫•n ƒë·ªÅ..." 
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeReportModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    H·ªßy
                </button>
                <button id="submitReportBtn" onclick="submitReport()" 
                        class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                    G·ª≠i b√°o c√°o
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Report Status Modal -->
<div id="reportStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Tr·∫°ng th√°i b√°o c√°o</h3>
                <button onclick="closeReportStatusModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="reportStatusContent" class="mb-4">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeReportStatusModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                    ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

<script src="~/js/propertyService.js"></script>
<script src="~/js/reportService.js"></script>
<script src="~/js/review.js"></script>
<script>
    let urlBase = "https://localhost:7031";
    //document.getElementById('listPostId').classList.add("text-orange-500");
    //document.getElementById('listPostId').classList.replace("border-gray-200", "border-orange-500");
    let id = @ViewBag.Id;
    let landlordId = 0;
    // Get current user ID from authentication token
    let currentUserId = 0;
    
    // Function to get current user ID from token
    function getCurrentUserIdFromToken() {
        try {
            // Get current user ID from token
            let token = localStorage.getItem('authToken');
            if (!token) {
                token = localStorage.getItem('accessToken');
            }
            if (!token) {
                token = localStorage.getItem('token');
            }
            
            console.log('Available localStorage keys:', Object.keys(localStorage));
            console.log('Token found:', !!token);
            
            if (!token) {
                console.log('No token found in localStorage');
                return 0;
            }
            
            // Decode token to get user ID
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userId = payload.id || payload.userId || payload.sub;
                console.log('Decoded token payload:', payload);
                console.log('User ID:', userId);
                return userId || 0;
            } catch (e) {
                console.error('Error decoding token:', e);
                return 0;
            }
        } catch (error) {
            console.error('Error getting current user ID:', error);
            return 0;
        }
    }
    
    // Initialize currentUserId when page loads
    function initializeCurrentUserId() {
        currentUserId = getCurrentUserIdFromToken();
        console.log('Initialized currentUserId:', currentUserId);
        
        // Always check if user is the owner first
        hideReportButtonForOwner();
        
        // If user is logged in, check report status
        if (currentUserId > 0) {
            checkReportStatus();
        } else {
            // User not logged in, show default report button state
            updateReportButtonForGuest();
        }
        
        // Add event listener for localStorage changes (login/logout)
        window.addEventListener('storage', function(e) {
            if (e.key === 'authToken' || e.key === 'accessToken' || e.key === 'token') {
                console.log('Token changed in localStorage:', e.key);
                refreshCurrentUserId();
            }
        });
        
        // Also listen for custom events if you have them
        window.addEventListener('userLogin', refreshCurrentUserId);
        window.addEventListener('userLogout', refreshCurrentUserId);
    }
    
    // Function to refresh current user ID (useful after login/logout)
    function refreshCurrentUserId() {
        const previousUserId = currentUserId;
        currentUserId = getCurrentUserIdFromToken();
        console.log('Refreshed currentUserId:', currentUserId, 'from:', previousUserId);
        
        if (currentUserId !== previousUserId) {
            // Always check if user is the owner first
            hideReportButtonForOwner();
            
            if (currentUserId > 0) {
                checkReportStatus();
            } else {
                updateReportButtonForGuest();
            }
        }
    }
    
    // Update report button for guest users (not logged in)
    function updateReportButtonForGuest() {
        const reportBtn = document.getElementById('reportBtn');
        const reportBtnText = document.getElementById('reportBtnText');
        
        // Check if user is the owner of the post - hide button if so
        hideReportButtonForOwner();
        
        // If user is the owner, don't proceed with button updates
        if (currentUserId > 0 && currentUserId === landlordId) {
            return;
        }
        
        reportBtnText.textContent = 'B√°o x·∫•u';
        reportBtn.onclick = () => {
            Swal.fire({
                icon: 'info',
                title: 'Vui l√≤ng ƒëƒÉng nh·∫≠p',
                text: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ b√°o c√°o b√†i ƒëƒÉng n√†y.',
                confirmButtonText: 'ƒêƒÉng nh·∫≠p',
                showCancelButton: true,
                cancelButtonText: 'H·ªßy'
            }).then((result) => {
                if (result.isConfirmed) {
                    
                    window.location.href = '/Auth/Login';
                }
            });
        };
        
        // Reset button styling
        reportBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-600', 'text-white', 'bg-yellow-600', 'bg-gray-200', 'text-gray-700');
        reportBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
    }
    
    // Function to hide report button if user is the owner of the post
    function hideReportButtonForOwner() {
        const reportBtn = document.getElementById('reportBtn');
       
        
        // Convert both to numbers to ensure proper comparison
        const currentUserIdNum = Number(currentUserId);
        const landlordIdNum = Number(landlordId);
        
        if (currentUserIdNum > 0 && currentUserIdNum === landlordIdNum) {
            reportBtn.style.display = 'none';
        } else {
            reportBtn.style.display = 'flex';
        }
    }
    
    // Check if user is logged in before allowing report
    function checkUserLogin() {
        if (currentUserId <= 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Vui l√≤ng ƒëƒÉng nh·∫≠p',
                text: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ c√≥ th·ªÉ b√°o c√°o. Vui l√≤ng ƒëƒÉng nh·∫≠p v√† th·ª≠ l·∫°i.',
                confirmButtonText: 'ƒê·ªìng √Ω',
                showCancelButton: true,
                cancelButtonText: 'H·ªßy'
            });
            return false;
        }
        return true;
    }
    let reportService = new ReportService();
    
    initializeCurrentUserId(); // Initialize currentUserId and check report status
    getProperty(); // Get property data and then check owner status
    let isOwner = false;
    getProperty();

    function openLandlord(){
        window.location.href= `/Home/Landlord/${landlordId}`;
    }

    // Report functions
    function openReportModal() {
        document.getElementById('reportModal').classList.remove('hidden');
    }

    function closeReportModal() {
        document.getElementById('reportModal').classList.add('hidden');
        // Reset form
        document.getElementById('reportReason').value = '';
        document.getElementById('reportDescription').value = '';
    }

    function closeReportStatusModal() {
        document.getElementById('reportStatusModal').classList.add('hidden');
    }

    async function checkReportStatus() {
        // Check if user is logged in
        if (!checkUserLogin()) {
            return;
        }

        try {
            const data = await reportService.checkReportStatus(id, 'PropertyPost', currentUserId);
            updateReportButton(data);
        } catch (error) {
            console.error('Error checking report status:', error);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: 'Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i b√°o c√°o',
                confirmButtonText: 'ƒê·ªìng √Ω'
            });
        }
    }

    function updateReportButton(data) {
        const reportBtn = document.getElementById('reportBtn');
        const reportBtnText = document.getElementById('reportBtnText');
        
        // Check if user is the owner of the post - hide button if so
        hideReportButtonForOwner();
        
        // If user is the owner, don't proceed with button updates
        if (currentUserId > 0 && currentUserId === landlordId) {
            return;
        }
        
        // Reset all classes first
        reportBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-600', 'text-white', 'bg-yellow-600', 'bg-gray-200', 'text-gray-700');
        
        // Check if user is logged in
        if (currentUserId <= 0) {
            updateReportButtonForGuest();
            return;
        }
        
        if (data.hasReported && !data.canReport) {
            // Already reported and pending - allow cancel
            reportBtnText.textContent = 'H·ªßy b√°o c√°o';
            reportBtn.onclick = () => cancelReport();
            reportBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
        } else if (data.hasReported && data.canReport) {
            // Can report again
            reportBtnText.textContent = 'B√°o c√°o l·∫°i';
            reportBtn.onclick = openReportModal;
            reportBtn.classList.add('bg-yellow-600', 'text-white', 'hover:bg-yellow-700');
        } else {
            // Never reported
            reportBtnText.textContent = 'B√°o x·∫•u';
            reportBtn.onclick = openReportModal;
            reportBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        }
    }

    function showReportStatus(data) {
        Swal.fire({
            title: 'Tr·∫°ng th√°i b√°o c√°o',
            html: `
                <div class="text-left">
                    <p><strong>Tr·∫°ng th√°i:</strong> <span class="text-blue-600">${data.status}</span></p>
                    <p><strong>Ng√†y b√°o c√°o:</strong> ${data.reportedAt}</p>
                    ${data.resolvedAt ? `<p><strong>Ng√†y x·ª≠ l√Ω:</strong> ${data.resolvedAt}</p>` : ''}
                    ${data.adminNote ? `<p><strong>Ghi ch√∫ c·ªßa admin:</strong> ${data.adminNote}</p>` : ''}
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'ƒê·ªìng √Ω'
        });
    }

    async function submitReport() {
        // Check if user is logged in
        if (!checkUserLogin()) {
            return;
        }

        const reason = document.getElementById('reportReason').value;
        const description = document.getElementById('reportDescription').value;

        if (!reason) {
            Swal.fire({
                icon: 'warning',
                title: 'Thi·∫øu th√¥ng tin',
                text: 'Vui l√≤ng ch·ªçn l√Ω do b√°o c√°o',
                confirmButtonText: 'ƒê·ªìng √Ω'
            });
            return;
        }

        // Show loading
        Swal.fire({
            title: 'ƒêang g·ª≠i b√°o c√°o...',
            text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const requestBody = {
                targetId: id,
                reason: reason,
                description: description
            };

            const result = await reportService.reportPropertyPost(currentUserId, requestBody);
            Swal.close();
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng!',
                text: result.message,
                confirmButtonText: 'ƒê·ªìng √Ω'
            });
            closeReportModal();
            checkReportStatus(); // Refresh button state
        } catch (error) {
            console.error('Error submitting report:', error);
            Swal.close();
            Swal.fire({
                icon: 'error',
                title: 'L·ªói!',
                text: error.message || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i b√°o c√°o',
                confirmButtonText: 'ƒê·ªìng √Ω'
            });
        }
    }

    async function cancelReport() {
        // Check if user is logged in
        if (!checkUserLogin()) {
            return;
        }

        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n h·ªßy b√°o c√°o',
            text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy b√°o c√°o n√†y?\n\nH·ªßy b√°o c√°o s·∫Ω x√≥a ho√†n to√†n b√°o c√°o c·ªßa b·∫°n v√† b·∫°n c√≥ th·ªÉ b√°o c√°o l·∫°i sau n√†y.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'H·ªßy b√°o c√°o',
            cancelButtonText: 'Kh√¥ng'
        });

        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'ƒêang h·ªßy b√°o c√°o...',
                text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await reportService.cancelPropertyPostReport(id, currentUserId);
                Swal.close();
                Swal.fire({
                    icon: 'success',
                    title: 'Th√†nh c√¥ng!',
                    text: response.message,
                    confirmButtonText: 'ƒê·ªìng √Ω'
                });
                checkReportStatus(); // Refresh button state
            } catch (error) {
                console.error('Error canceling report:', error);
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'L·ªói!',
                    text: error.message || 'C√≥ l·ªói x·∫£y ra khi h·ªßy b√°o c√°o',
                    confirmButtonText: 'ƒê·ªìng √Ω'
                });
            }
        }
    }

    async function getProperty(){
        let prop = await propertyService.getProperty(id);
        //console.log(prop);
        landlordId = prop.landlordId;
        console.log('getProperty - landlordId set to:', landlordId, 'currentUserId:', currentUserId);
        const token = localStorage.getItem('authToken');
        if(token){
            let userId = 0;
            const payload = JSON.parse(atob(token.split('.')[1]));
            userId = payload.id;
            isOwner = prop.landlordId = userId ? true : false;
        }

        let addressInfo = prop.detailedAddress + ", " + prop.street + ", " + prop.ward + ", " + prop.province;
        $('.titleId').html(prop.title);
        renderStarsBody(prop.rating);
        $('#avgStar').html("(" + prop.rating + ")");
        $('#totalComment').html(prop.commentNo);
        
        $('.landlordUrl').prop('src',prop.landlordProfilePictureUrl?.includes('http') ? prop.landlordProfilePictureUrl : urlBase + prop.landlordProfilePictureUrl)
        // $('#imgPrimaryUrl').prop('src',prop.primaryImageUrl.includes("http") ? prop.primaryImageUrl : urlBase + prop.primaryImageUrl);
        $('.areaId').html(prop.area);
        $('.addressId').html(addressInfo);
        $('.priceId').html(formatVietnameseNumber(prop.price) + " ƒë");
        $('.timeAgoId').html(timeAgo(prop.createdAt));
        $('.descriptionId').html(prop.description);
        $('.wardId').html(prop.ward);
        $('.provinceId').html(prop.province);
        $('#propId').html(prop.id);
        $('#createTimeId').html(formatVietnameseDateTime(prop.createdAt));
        $('.contactPhone').html(prop.landlordPhoneNumber);
        $('.contactName').html(prop.landlordName);
        if(!prop.isFavorite) $('#addFavoriteDetail').removeClass('d-none');
        else $('#removeFavoriteDetail').removeClass('d-none');
        let htmlUrl = "";
        $('#listImgs').html('');
        if(prop.imageUrls != null){
            prop.imageUrls.forEach((url,index) => {
                var src = url.includes("http") ? url : urlBase + url;
                if(index == 0) htmlUrl += `<div onclick="selectImg(this)" class="border-2 border-red-500 rounded p-1 imgDetail">
                                <img src="${src}" onerror="handleImageError(this)" class="w-20 h-16 object-cover" />
                            </div>`;
                else htmlUrl += `
                                 <div onclick="selectImg(this)" class="border-2 border-white rounded p-1 imgDetail">
                                    <img src="${src}" onerror="handleImageError(this)" class="w-20 h-16 object-cover" />
                                 </div>`;
            });
            $('#listImgs').html(htmlUrl);
        }

        if (prop.location != null) {
            let lCoor = prop.location.split(',');
            const lat = lCoor[0];
            const lng = lCoor[1];

            $('#mapFrame').attr('src', `https://www.google.com/maps?q=${lat},${lng}&output=embed`);
        }
        else {
            const encodedLocation = encodeURIComponent(addressInfo);
            $('#mapFrame').attr('src', `https://www.google.com/maps?q=${encodedLocation}&output=embed`);
        }

        //console.log(prop);
        listNewPost = await propertyService.getNewPost();
        //console.log(listNewPost);
        let htmlNew = '';
        listNewPost.forEach(item => {
            const imageUrl = item.images && item.images.length > 0 && item.images[0] && item.images[0].imageUrl 
                ? (item.images[0].imageUrl.includes('http') ? item.images[0].imageUrl : urlBase + item.images[0].imageUrl)
                : '/image/default-news.jpg'; // Default image path
            
            htmlNew += `<div style="cursor:pointer" onclick="window.location.href='/Home/NewDetail/${item.id}'" class="flex gap-2 items-start">
                    <img src="${imageUrl}" onerror="handleImageError(this)" alt="tin" class="w-14 h-14 rounded object-cover" />
                    <div>
                        <div class="text-sm font-medium text-gray-800 leading-snug line-clamp-2">
                            ${item.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'}
                        </div>
                        <div class="text-xs text-gray-500">${timeAgo(item.publishedAt)}</div>
                    </div>
                </div>`
        });
        $('#listNew').html(htmlNew);
        
        // Check if current user is the owner and hide report button if so
        hideReportButtonForOwner();

        let commentHTMLBody = "";
        var listReview = await getComment(id);
            listReview.items.forEach(item => {
            var commentHTML = createCommentHTML(item,isOwner);
            commentHTMLBody += commentHTML.innerHTML;
        });
        list.innerHTML = commentHTMLBody;
    }

    function selectImg(el1){
        document.querySelectorAll('.imgDetail').forEach(function(el) {
            el.classList.replace("border-red-500", "border-white");
        });
        el1.classList.replace("border-white", "border-red-500");
        const img = el1.querySelector('img');
        document.getElementById('imgPrimaryUrl').src = img.src;
    }

    //comment
    const form = document.getElementById('commentForm');
    const input = document.getElementById('commentInput');
    const list = document.getElementById('commentList');
    const ratingStars = document.getElementById('ratingStars');

    let selectedRating = 0;

    renderStars(ratingStars, (rating) => selectedRating = rating);

    function renderStars(container, callback) {
      container.innerHTML = '';
      let localRating = 0;
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.innerHTML = '‚òÖ';
        star.className = 'text-2xl cursor-pointer text-gray-300 hover:text-yellow-400 transition';
        star.dataset.value = i;

        star.addEventListener('mouseover', () => highlightStars(container, i, localRating));
        star.addEventListener('mouseout', () => highlightStars(container, localRating, localRating));
        star.addEventListener('click', () => {
          localRating = i;
          highlightStars(container, i, localRating);
          callback(i);
        });

        container.appendChild(star);
      }
    }

    function highlightStars(container, rating, selected) {
      const stars = container.querySelectorAll('span');
      stars.forEach((star, index) => {
        star.classList.remove('text-yellow-400', 'text-gray-300');
        star.classList.add(index < rating ? 'text-yellow-400' : 'text-gray-300');
      });
    }

    function createCommentHTML(name, text, stars, time, img) {
      const starsDisplay = '‚òÖ'.repeat(stars) + ' ‚òÜ'.repeat(5 - stars);
      const comment = document.createElement('div');
      comment.className = 'flex space-x-4 items-start';

      comment.innerHTML = `
        <img src="${img}" alt="avatar" class="w-12 h-12 rounded-full shadow-sm">
        <div class="flex-1">
          <div class="bg-gray-50 p-4 rounded-xl shadow-sm hover:shadow transition">
            <div class="flex items-center justify-between mb-1">
              <span class="font-semibold text-gray-800">${name}</span>
              <span class="text-sm text-gray-500">${timeAgo(time)}</span>
            </div>
            <div class="flex mb-2">
              <span class="text-yellow-400">${starsDisplay}</span>
            </div>
            <p class="text-gray-700">${text}</p>
            <button class="text-sm text-blue-500 mt-2 hover:underline replyBtn">Tr·∫£ l·ªùi</button>
            <button class="text-sm text-red-500 hover:underline report-btn">B√°o c√°o</button>
            <div class="replies space-y-3 mt-3 pl-8 border-l border-gray-200"></div>
          </div>
        </div>
      `;


      const replyBtn = comment.querySelector('.replyBtn');
      const repliesContainer = comment.querySelector('.replies');

      replyBtn.addEventListener('click', () => {
        if (comment.querySelector('.replyForm')) return;

        const replyForm = document.createElement('form');
        replyForm.className = 'replyForm mt-3';
        replyForm.innerHTML = `
          <textarea placeholder="Vi·∫øt tr·∫£ l·ªùi..."
            class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
            rows="2"></textarea>
          <button type="submit"
            class="mt-2 bg-green-500 hover:bg-green-600 text-white text-sm px-4 py-1 rounded-lg">
            G·ª≠i tr·∫£ l·ªùi
          </button>
        `;

        replyForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const replyText = replyForm.querySelector('textarea').value.trim();
          if (replyText) {
            const reply = document.createElement('div');
            reply.className = 'flex space-x-3 items-start';
            reply.innerHTML = `
              <img src="https://i.pravatar.cc/36?u=${Math.random()}" alt="avatar" class="w-9 h-9 rounded-full shadow-sm">
              <div class="bg-white p-3 rounded-lg shadow-sm flex-1">
                <div class="font-semibold text-sm">Ng∆∞·ªùi tr·∫£ l·ªùi <span class="text-gray-500 text-xs">v·ª´a xong</span></div>
                <p class="text-gray-700 text-sm">${replyText}</p>
              </div>
            `;
            repliesContainer.appendChild(reply);
            replyForm.remove();
          }
        });

        repliesContainer.appendChild(replyForm);
      });

      return comment;
    }


    function createCommentHTML(item, isOwner = false) {
      const starsDisplay = '‚òÖ'.repeat(item.rating) + '‚òÜ'.repeat(5 - item.rating);
      const comment = document.createElement('div');
      comment.className = 'flex space-x-4 items-start';

      comment.innerHTML = `
        <img src="${item.renterImg}" alt="avatar" class="w-12 h-12 rounded-full shadow-sm" style="display:none">
        <div class="flex-1">
          <div class="bg-gray-50 p-4 rounded-xl shadow-sm hover:shadow transition">
            <div class="flex items-center justify-between mb-1">
              <span style="cursor:pointer" onclick="window.location.href='/Home/Landlord/${item.renterId}'" class="font-semibold text-gray-800">${item.renterName}</span>
              <span class="text-sm text-gray-500">${timeAgo(item.createdAt)}</span>
            </div>
            <div class="flex mb-2">
              <span class="text-yellow-400">${starsDisplay}</span>
            </div>
            <p class="text-gray-700">${item.reviewText}</p>
            ${isOwner && !item.reply ? `
                 <button class="text-sm text-blue-500 mt-2 hover:underline replyBtn-${item.reviewId}">Tr·∫£ l·ªùi</button>
            ` : `<button class="text-sm text-blue-500 mt-2 hover:underline replyBtn-${item.reviewId}" style="display:none">Tr·∫£ l·ªùi</button>`
            }
            ${isOwner ? `
                 <button class="text-sm text-red-500 hover:underline report-btn" style="display:none">B√°o c√°o</button>
            ` : ''}
            <div class="replies space-y-3 mt-3 pl-8 border-l border-gray-200"></div>
          </div>
        </div>
      `;
      const replyBtn = comment.querySelector('.replyBtn-'+ item.reviewId);
      const repliesContainer = comment.querySelector('.replies');
      if(item.reply){
          const reply = document.createElement('div');
            reply.className = 'flex space-x-3 items-start';
            reply.id = `reply-${item.reply.id}`;
            reply.innerHTML = `
              <img src="${item.reply.img}" alt="avatar" style="display:none" class="w-9 h-9 rounded-full shadow-sm">
              <div class="bg-white p-3 rounded-lg shadow-sm flex-1">
                <div style="cursor:pointer" onclick="window.location.href='/Home/Landlord/${item.reply.landlordId}'" class="font-semibold text-sm">Ch·ªß b√†i ƒëƒÉng <span class="text-gray-500 text-xs">${timeAgo(item.reply.createdAt)}</span></div>
                <p class="text-gray-700 text-sm">${item.reply.replyContent}</p>
                ${isOwner ? `
                    <button onclick="editReply(${item.reply.id},${item.reviewId})" class="text-sm text-blue-500 mt-2 hover:underline replyBtn">Ch·ªânh s·ª≠a</button>
                ` : ''}
              </div>
            `;
           repliesContainer.appendChild(reply);
      }
      // else{

      // }


      replyBtn.addEventListener('click', () => {
        if (comment.querySelector('.replyForm')) return;

        const replyForm = document.createElement('form');
        replyForm.className = 'replyForm mt-3';
        replyForm.id = `replyForm-${item.reply.id}`;
        replyForm.innerHTML = `
          <textarea placeholder="Vi·∫øt tr·∫£ l·ªùi..."
            class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
            rows="2" value="${item.reply?.replyContent ?? ''}">${item.reply?.replyContent ?? ''}</textarea>
          <button type="submit"
            class="mt-2 bg-green-500 hover:bg-green-600 text-white text-sm px-4 py-1 rounded-lg">
            G·ª≠i tr·∫£ l·ªùi
          </button>
          <button type="button" onclick="cancelReply(${item.reply.id},${item.reviewId})"
            class="mt-2 bg-gray-500 hover:bg-gray-600 text-white text-sm px-4 py-1 rounded-lg">
            Tr·ªü l·∫°i
          </button>
        `;

        replyForm.addEventListener('submit',(e) => {
          e.preventDefault();
          const replyText = replyForm.querySelector('textarea').value.trim();
          let dto = {
              replyId: replyForm.id.replace('replyForm-',''),
              replyContent: replyText,
          }
          dto['replyId'] = Number(dto['replyId']);
          //console.log(dto);
          editReplyComment(dto);
        });

        repliesContainer.appendChild(replyForm);
      });

      return comment;
    }

    async function cancelReply(id,reviewId){
        $(`#reply-${id}`).show();
        $(`.replyForm`).hide();
    }

    async function editReply(id,reviewId){
        $(`#reply-${id}`).hide();
        $(`.replyForm`).show();
        $(`.replyBtn-${reviewId}`).click();
    }

    form.addEventListener('submit',function(e) {
      e.preventDefault();
      const text = input.value.trim();
      if (text && selectedRating > 0) {
        let dto = {
          propertyPostId: id,
          reviewText: text,
          rating: selectedRating
        };
        addComment(dto);
      } else {
        alert('Vui l√≤ng nh·∫≠p b√¨nh lu·∫≠n v√† ch·ªçn s·ªë sao.');
      }
    });

</script>
