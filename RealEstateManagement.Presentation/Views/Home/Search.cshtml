@{
    Layout = "~/Views/Shared/_LayoutV2.cshtml";
    ViewData["Title"] = "Tìm kiếm bất động sản";
}

<link rel="stylesheet" href="~/css/search.css">
<link rel="stylesheet" href="~/css/HomePage.css">

<style>
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .dual-range-container {
        position: relative;
        width: 100%;
        padding: 10px 0;
    }

    .dual-range-track {
        position: relative;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
    }

    .dual-range-filled {
        position: absolute;
        height: 6px;
        background: #2563eb;
        border-radius: 3px;
    }

    .dual-range-container input[type="range"] {
        position: absolute;
        width: 100%;
        height: 6px;
        margin: 0;
        pointer-events: none;
        background: none;
        -webkit-appearance: none;
    }

        .dual-range-container input[type="range"]::-webkit-slider-thumb {
            pointer-events: auto;
            width: 16px;
            height: 16px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            -webkit-appearance: none;
        }

    .range-values {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #333;
        margin-top: 5px;
    }
</style>

<div class="search-container">
    <!-- Search Header -->
    <div class="search-header">
        <h1>Tìm kiếm bất động sản</h1>
        <p>Khám phá những ngôi nhà tuyệt vời phù hợp với nhu cầu của bạn</p>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <form id="searchForm" class="search-form">
            <div class="form-group">
                <label for="searchType">Loại bất động sản</label>
                <select id="searchType" name="type">
                    <option value="">Tất cả loại</option>
                </select>
            </div>
            <div class="form-group">
                <label for="searchProvince">Tỉnh/Thành phố</label>
                <select id="searchProvince" name="province">
                    <option value="">Tất cả tỉnh</option>
                </select>
            </div>
            <div class="form-group">
                <label for="searchKeyword">Từ khóa</label>
                <input type="text" id="searchKeyword" name="keyword" placeholder="Nhập từ khóa tìm kiếm...">
            </div>
            <button type="submit" class="search-btn">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                Tìm kiếm
            </button>
        </form>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-header">
            <h3>Bộ lọc nâng cao</h3>
            <button type="button" class="filter-toggle" id="filterToggle">Hiện bộ lọc</button>
        </div>
        <div class="filter-content" id="filterContent" style="display: none;">
            <div class="filter-group">
                <label>Giá (triệu VNĐ/tháng)</label>
                <div class="dual-range-container">
                    <div class="dual-range-track">
                        <div class="dual-range-filled" id="priceRangeFilled"></div>
                    </div>
                    <input type="range" id="minPrice" name="minPrice" min="0" max="50" value="0" step="1">
                    <input type="range" id="maxPrice" name="maxPrice" min="0" max="50" value="50" step="1">
                    <div class="range-values">
                        <span id="minPriceValue">0 triệu</span>
                        <span id="maxPriceValue">50 triệu</span>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label>Diện tích (m²)</label>
                <div class="dual-range-container">
                    <div class="dual-range-track">
                        <div class="dual-range-filled" id="areaRangeFilled"></div>
                    </div>
                    <input type="range" id="minArea" name="minArea" min="0" max="500" value="0" step="10">
                    <input type="range" id="maxArea" name="maxArea" min="0" max="500" value="500" step="10">
                    <div class="range-values">
                        <span id="minAreaValue">0 m²</span>
                        <span id="maxAreaValue">500 m²</span>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label>Số phòng</label>
                <div class="dual-range-container">
                    <div class="dual-range-track">
                        <div class="dual-range-filled" id="roomRangeFilled"></div>
                    </div>
                    <input type="range" id="minRoom" name="minRoom" min="0" max="10" value="0" step="1">
                    <input type="range" id="maxRoom" name="maxRoom" min="0" max="10" value="10" step="1">
                    <div class="range-values">
                        <span id="minRoomValue">0</span>
                        <span id="maxRoomValue">10</span>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label for="searchWard">Quận/Huyện</label>
                <select id="searchWard" name="ward">
                    <option value="">Tất cả quận/huyện</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchStreet">Đường/Phố</label>
                <select id="searchStreet" name="street">
                    <option value="">Tất cả đường/phố</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
        <div class="results-header">
            <div class="results-count">
                Tìm thấy <strong id="totalResults">0</strong> bất động sản
            </div>
            <div class="sort-options">
                <label for="sortBy">Sắp xếp theo:</label>
                <select id="sortBy" name="sortBy">
                    <option value="newest">Mới nhất</option>
                    <option value="price_asc">Giá tăng dần</option>
                    <option value="price_desc">Giá giảm dần</option>
                    <option value="area_asc">Diện tích tăng dần</option>
                    <option value="area_desc">Diện tích giảm dần</option>
                </select>
            </div>
        </div>

        <!-- Properties Grid -->
        <div id="propertiesContainer">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
            <button class="pagination-btn" id="prevPage" disabled>Trước</button>
            <div id="pageNumbers"></div>
            <button class="pagination-btn" id="nextPage">Tiếp</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/helper.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiBaseUrl = 'https://localhost:7031/api';
            let currentPage = 1;
            let currentPageSize = 12;
            let totalPages = 0;
            let totalItems = 0;
            let currentFilters = {};

            // Initialize
            loadProvinces();
            loadPropertyTypes();
            loadAmenities();
            setupDualRangeSliders();

            // Filter toggle
            document.getElementById('filterToggle').addEventListener('click', function() {
                const filterContent = document.getElementById('filterContent');
                const isVisible = filterContent.style.display !== 'none';
                filterContent.style.display = isVisible ? 'none' : 'grid';
                this.textContent = isVisible ? 'Hiện bộ lọc' : 'Ẩn bộ lọc';
                this.classList.toggle('active');
            });

            // Search form submit
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 1;
                performSearch();
            });

            // Province change
            document.getElementById('searchProvince').addEventListener('change', function() {
                const provinceId = this.value;
                loadWards(provinceId);
                document.getElementById('searchWard').innerHTML = '<option value="">Tất cả quận/huyện</option>';
                document.getElementById('searchStreet').innerHTML = '<option value="">Tất cả đường/phố</option>';
            });

            // Ward change
            document.getElementById('searchWard').addEventListener('change', function() {
                const wardId = this.value;
                loadStreets(wardId);
                document.getElementById('searchStreet').innerHTML = '<option value="">Tất cả đường/phố</option>';
            });

            // Sort change
            document.getElementById('sortBy').addEventListener('change', function() {
                performSearch();
            });

            // Load provinces
            async function loadProvinces() {
                try {
                    const response = await fetch(`${apiBaseUrl}/Property/provinces`);
                    const provinces = await response.json();
                    const provinceSelect = document.getElementById('searchProvince');
                    provinces.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.id;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading provinces:', error);
                }
            }

            // Load property types
            async function loadPropertyTypes() {
                try {
                    const response = await fetch(`${apiBaseUrl}/PropertyType/GetAllPropertyTypes`);
                    const propertyTypes = await response.json();
                    const typeSelect = document.getElementById('searchType');
                    typeSelect.innerHTML = '<option value="">Tất cả loại</option>';
                    propertyTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.name;
                        option.textContent = type.name;
                        typeSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading property types:', error);
                    document.getElementById('searchType').innerHTML = '<option value="">Không thể tải loại</option>';
                }
            }

            // Load amenities
            async function loadAmenities() {
                try {
                    const response = await fetch(`${apiBaseUrl}/Property/amenities`);
                    const amenities = await response.json();
                    window.amenities = amenities;
                } catch (error) {
                    console.error('Error loading amenities:', error);
                }
            }

            // Setup dual-range sliders
            function setupDualRangeSliders() {
                const sliders = [
                    {
                        minId: 'minPrice',
                        maxId: 'maxPrice',
                        filledId: 'priceRangeFilled',
                        minValueId: 'minPriceValue',
                        maxValueId: 'maxPriceValue',
                        min: 0,
                        max: 50,
                        step: 1,
                        format: value => `${value} triệu`
                    },
                    {
                        minId: 'minArea',
                        maxId: 'maxArea',
                        filledId: 'areaRangeFilled',
                        minValueId: 'minAreaValue',
                        maxValueId: 'maxAreaValue',
                        min: 0,
                        max: 500,
                        step: 10,
                        format: value => `${value} m²`
                    },
                    {
                        minId: 'minRoom',
                        maxId: 'maxRoom',
                        filledId: 'roomRangeFilled',
                        minValueId: 'minRoomValue',
                        maxValueId: 'maxRoomValue',
                        min: 0,
                        max: 10,
                        step: 1,
                        format: value => value
                    }
                ];

                sliders.forEach(slider => {
                    const minInput = document.getElementById(slider.minId);
                    const maxInput = document.getElementById(slider.maxId);
                    const filledTrack = document.getElementById(slider.filledId);
                    const minValueSpan = document.getElementById(slider.minValueId);
                    const maxValueSpan = document.getElementById(slider.maxValueId);

                    // Initialize values
                    minValueSpan.textContent = slider.format(minInput.value);
                    maxValueSpan.textContent = slider.format(maxInput.value);
                    updateFilledTrack(slider);

                    // Event listeners
                    minInput.addEventListener('input', () => {
                        if (parseFloat(minInput.value) > parseFloat(maxInput.value)) {
                            minInput.value = maxInput.value;
                        }
                        minValueSpan.textContent = slider.format(minInput.value);
                        maxValueSpan.textContent = slider.format(maxInput.value);
                        updateFilledTrack(slider);
                        debounceSearch();
                    });

                    maxInput.addEventListener('input', () => {
                        if (parseFloat(maxInput.value) < parseFloat(minInput.value)) {
                            maxInput.value = minInput.value;
                        }
                        minValueSpan.textContent = slider.format(minInput.value);
                        maxValueSpan.textContent = slider.format(maxInput.value);
                        updateFilledTrack(slider);
                        debounceSearch();
                    });

                    // Update filled track
                    function updateFilledTrack(slider) {
                        const minValue = parseFloat(minInput.value);
                        const maxValue = parseFloat(maxInput.value);
                        const range = slider.max - slider.min;
                        const leftPercent = ((minValue - slider.min) / range) * 100;
                        const rightPercent = ((maxValue - slider.min) / range) * 100;
                        filledTrack.style.left = `${leftPercent}%`;
                        filledTrack.style.width = `${rightPercent - leftPercent}%`;
                    }
                });
            }

            // Debounce search to limit API calls
            let debounceTimeout;
            function debounceSearch() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(performSearch, 300);
            }

            // Helper function để xử lý ảnh
            function getPropertyImageUrl(property) {
                const defaultImage = '/image/no-image.png';
                if (!property.imageUrls || !Array.isArray(property.imageUrls) || property.imageUrls.length === 0) {
                    if (property.primaryImageUrl && property.primaryImageUrl.trim() !== '') {
                        return property.primaryImageUrl.includes('http') ? property.primaryImageUrl : `https://localhost:7031${property.primaryImageUrl}`;
                    }
                    return defaultImage;
                }
                let selectedImage = property.imageUrls.find(img => typeof img === 'object' && img.isPrimary === true);
                if (!selectedImage) selectedImage = property.imageUrls[0];
                if (selectedImage) {
                    if (typeof selectedImage === 'object' && selectedImage.url) {
                        return selectedImage.url.includes('http') ? selectedImage.url : `https://localhost:7031${selectedImage.url}`;
                    } else if (typeof selectedImage === 'string' && selectedImage.trim() !== '') {
                        return selectedImage.includes('http') ? selectedImage : `https://localhost:7031${selectedImage}`;
                    }
                }
                if (property.primaryImageUrl && property.primaryImageUrl.trim() !== '') {
                    return property.primaryImageUrl.includes('http') ? property.primaryImageUrl : `https://localhost:7031${property.primaryImageUrl}`;
                }
                return defaultImage;
            }

            // Handle image loading errors
            function handleImageError(img) {
                img.src = '/image/no-image.png';
                img.alt = 'Không có ảnh';
                img.onerror = null;
            }

            // Perform search
            async function performSearch() {
                const searchParams = new URLSearchParams();
                searchParams.append('page', currentPage);
                searchParams.append('pageSize', currentPageSize);

                const type = document.getElementById('searchType').value;
                const province = document.getElementById('searchProvince').value;
                const ward = document.getElementById('searchWard').value;
                const street = document.getElementById('searchStreet').value;
                const keyword = document.getElementById('searchKeyword').value;
                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;
                const minArea = document.getElementById('minArea').value;
                const maxArea = document.getElementById('maxArea').value;
                const minRoom = document.getElementById('minRoom').value;
                const maxRoom = document.getElementById('maxRoom').value;
                const sortBy = document.getElementById('sortBy').value;

                if (type && type.trim() !== '') searchParams.append('type', type);
                if (province) searchParams.append('provinces', province);
                if (ward) searchParams.append('wards', ward);
                if (street) searchParams.append('streets', street);
                if (keyword) searchParams.append('keyword', keyword);
                if (minPrice && minPrice !== '0') searchParams.append('minPrice', minPrice);
                if (maxPrice && maxPrice !== '50') searchParams.append('maxPrice', maxPrice);
                if (minArea && minArea !== '0') searchParams.append('minArea', minArea);
                if (maxArea && maxArea !== '500') searchParams.append('maxArea', maxArea);
                if (minRoom && minRoom !== '0') searchParams.append('minRoom', minRoom);
                if (maxRoom && maxRoom !== '10') searchParams.append('maxRoom', maxRoom);
                if (sortBy) searchParams.append('sortBy', sortBy);

                currentFilters = Object.fromEntries(searchParams.entries());

                showLoading();

                try {
                    const response = await fetch(`${apiBaseUrl}/Property/homepage-paginated?${searchParams.toString()}`);
                    const result = await response.json();
                    if (response.ok) {
                        displayResults(result);
                    } else {
                        showError(result.message || 'Có lỗi xảy ra khi tìm kiếm');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    showError('Không thể kết nối đến server');
                }
            }

            // Display results
            function displayResults(result) {
                const container = document.getElementById('propertiesContainer');
                if (!result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>Không tìm thấy bất động sản nào phù hợp với tiêu chí tìm kiếm</p>
                        </div>
                    `;
                    document.getElementById('pagination').style.display = 'none';
                    document.getElementById('totalResults').textContent = '0';
                    return;
                }

                totalItems = result.totalItems || result.data.length;
                totalPages = Math.ceil(totalItems / currentPageSize);
                document.getElementById('totalResults').textContent = totalItems;

                const propertiesHtml = result.data.map(property => createPropertyCard(property)).join('');
                container.innerHTML = propertiesHtml;

                renderPagination();
                document.getElementById('pagination').style.display = 'flex';
            }

            // Create property card
            function createPropertyCard(property) {
                const token = localStorage.getItem("authToken");
                let isOwner = false;
                if (token) {
                    const userId = getUserIdFromToken(token);
                    if (userId && property.landlordId && userId === property.landlordId) {
                        isOwner = true;
                    }
                }
                const detailUrl = isOwner
                    ? `/PostProperty/DetailProperty/${property.id}`
                    : `/Home/Detail/${property.id}`;

                const imageUrl = getPropertyImageUrl(property);
                const price = property.price ? `${formatVietnameseNumber(property.price)}` : 'Thỏa thuận';
                const area = property.area ? `${property.area}m²` : 'N/A';
                const bedrooms = property.bedrooms || 'N/A';
                const address = property.detailedAddress || property.address || 'Không có địa chỉ';
                const street = property.street || '';
                const ward = property.ward || '';
                const province = property.province || '';
                const fullAddress = [address, street, ward, province].filter(Boolean).join(', ');

                // Calculate time ago
                const timeAgoText = timeAgo(property.createdAt);
                
                // Count images
                const imageCount = property.imageUrls && Array.isArray(property.imageUrls) ? property.imageUrls.length : 0;

                return `
                    <div id="card-property-${property.id}" class="property-card" data-id="${property.id}">
                        <div class="property-image-container">
                            <img
                                onerror="handleImageError(this)"
                                src="${imageUrl}"
                                alt="${property.type || 'Bất động sản'}"
                                class="property-image"
                                loading="lazy"
                            >
                            <div class="property-overlay"></div>
                            
                            <!-- Time Badge -->
                            <div class="image-badge time-badge">
                                ${timeAgoText}
                            </div>
                            
                            <!-- Photo Count Badge -->
                            <div class="image-badge photo-badge">
                                ${imageCount}
                                <svg width="12" height="12" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                                </svg>
                            </div>
                            
                            <!-- Promotion Badge -->
                            ${property.promotionPackageName ? `
                            <div class="promotion-badge">
                                <i class="fas fa-star"></i>
                                ${property.promotionPackageName}
                            </div>
                            ` : ''}
                        </div>

                        <!-- Property Content -->
                        <div class="property-content">
                            <div class="property-header">
                                <div class="property-status-indicator"></div>
                                <h3
                                    onclick="window.location.href='${detailUrl}'"
                                    class="property-title"
                                    title="${property.title || 'Không có tiêu đề'}"
                                >
                                    ${property.title || 'Không có tiêu đề'}
                                </h3>
                            </div>
                            
                            <div class="property-price">
                                <span>${price}</span>
                                <span class="price-negotiable">TL</span>
                            </div>
                            
                            <div class="property-features">
                                <div class="feature-line">
                                    <span class="feature-item">${bedrooms} PN</span>
                                    <span class="feature-separator">•</span>
                                    <span class="feature-item">Hướng Bắc</span>
                                    <span class="feature-separator">•</span>
                                    <span class="feature-item">Nhà ngõ, hẻm</span>
                                </div>
                                <div class="feature-line">
                                    <span class="feature-item">${property.price && property.area ? Math.round(property.price / property.area / 1000000) : 'N/A'} tr/m²</span>
                                    <span class="feature-separator">•</span>
                                    <span class="feature-item">${area}</span>
                                </div>
                            </div>
                            
                            <div class="property-location">
                                <svg class="location-icon" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                </svg>
                                <span>${province || 'Tp Hồ Chí Minh'}</span>
                            </div>

                            <!-- Property Footer -->
                            <div class="property-footer">
                                <div class="landlord-info">
                                    <div 
                                        class="landlord-avatar"
                                        onclick="window.location.href='/Home/Landlord/${property.landlordId || 0}'"
                                        title="Xem thông tin chủ nhà"
                                    >
                                        <img
                                            onerror="handleImageError(this)"
                                            src="${property.landlordProfilePictureUrl?.includes('http') ? property.landlordProfilePictureUrl : `https://localhost:7031${property.landlordProfilePictureUrl}`}"
                                            alt="Ảnh chủ nhà"
                                            class="w-full h-full object-cover"
                                        >
                                    </div>
                                    <div class="landlord-details">
                                        <div 
                                            class="landlord-name"
                                            onclick="window.location.href='/Home/Landlord/${property.landlordId || 0}'"
                                            title="Xem thông tin chủ nhà"
                                        >
                                            ${property.landlordName || 'Không có tên'}
                                        </div>
                                        <div class="landlord-stats">
                                            <i class="fas fa-briefcase"></i>
                                            // <span>20 tin đăng</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Property Actions -->
                                <div class="property-actions">
                                    <button
                                        id="btnFavourite-${property.id}"
                                        onclick="updateFavorite(${property.id}, ${property.isFavorite || false})"
                                        class="action-btn heart"
                                        title="Yêu thích"
                                    >
                                        ${property.isFavorite
                                            ? `<svg id="heart-icon-${property.id}" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 7.284a5.754 5.754 0 00-9.406-1.045L12 7.158l-.346-.92A5.754 5.754 0 002.248 7.284c-1.1 2.238-.432 4.92 1.528 6.596l7.04 6.211a.75.75 0 001.368 0l7.04-6.211c1.96-1.676 2.628-4.358 1.528-6.596z" />
                                               </svg>`
                                            : `<svg id="heart-icon-${property.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 7.284a5.754 5.754 0 00-9.406-1.045L12 7.158l-.346-.92A5.754 5.754 0 002.248 7.284c-1.1 2.238-.432 4.92 1.528 6.596l7.04 6.211a.75.75 0 001.368 0l7.04-6.211c1.96-1.676 2.628-4.358 1.528-6.596z" />
                                               </svg>`
                                        }
                                    </button>
                                    <button
                                        id="btn-compare-${property.id}"
                                        onclick="addToCompare(${property.id})"
                                        class="action-btn compare"
                                        title="So sánh"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" />
                                        </svg>
                                    </button>
                                    <button
                                        id="interest-${property.id}"
                                        onclick="clickInterest(${property.id},${property.isInterested || false},${property.interestedStatus || 0},${property.isReminderRenterConfirmInterested || 0},${property.interestedId || 0})"
                                        class="action-btn interest"
                                        title="Quan tâm"
                                    >
                                        <i class="fa-solid fa-square-plus ${property.isInterested && property.interestedStatus != 1 ? 'text-red-500' : ''}"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Render pagination
            function renderPagination() {
                const pageNumbers = document.getElementById('pageNumbers');
                const prevBtn = document.getElementById('prevPage');
                const nextBtn = document.getElementById('nextPage');

                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;

                let pageNumbersHtml = '';
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    pageNumbersHtml += `
                        <button class="pagination-btn ${i === currentPage ? 'active' : ''}"
                                onclick="goToPage(${i})">${i}</button>
                    `;
                }

                pageNumbers.innerHTML = pageNumbersHtml;
            }

            // Navigation functions
            window.goToPage = function(page) {
                currentPage = page;
                performSearch();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            window.viewProperty = function(propertyId) {
                window.location.href = `/Home/Detail/${propertyId}`;
            };

            window.toggleFavorite = function(event, propertyId, isFavorite) {
                event.stopPropagation();
                updateFavorite(propertyId, isFavorite);
            };

            // Event listeners for pagination
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            });

            document.getElementById('nextPage').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            });

            // Utility functions
            function showLoading() {
                document.getElementById('propertiesContainer').innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Đang tìm kiếm...</p>
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
            }

            function showError(message) {
                document.getElementById('propertiesContainer').innerHTML = `
                    <div class="empty-state">
                        <p style="color: #dc2626;">${message}</p>
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
            }

            // Helper functions
            function getUserIdFromToken(token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return parseInt(payload["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"]);
                } catch (error) {
                    console.error("Không thể giải mã token:", error);
                    return null;
                }
            }

            function StatusInterest(item) {
                if (!item.isInterested) return "";
                if (item.interestedStatus == 2) {
                    if (item.isReminderRenterConfirmInterested == 2) return `<span style="color:red">Quá hạn xác nhận quan tâm</span>`;
                    if (item.isReminderRenterConfirmInterested == 1) return `<span style="color:green">Xác nhận quan tâm lại</span>`;
                    if (item.isReminderRenterConfirmInterested == 0) return `<span style="color:blue">Chờ phản hồi hệ thống</span>`;
                }
                if (item.interestedStatus == 0) return "";
                if (item.interestedStatus == 3) {
                    if (item.isReminderRenterConfirmInterested == 0) return `<span style="color:blue">Chờ xác nhận từ người cho thuê</span>`;
                }
            }

            // Favorite functions
            async function updateFavorite(id, isFavorite) {
                const isAuthenticated = checkAuthStatus();
                if (!isAuthenticated) {
                    window.location.href = '/Auth/Login';
                    return;
                }
                try {
                    if (!isFavorite) {
                        await addToFavourite(id);
                    } else {
                        await removeToFavorite(id);
                    }
                } catch (error) {
                    console.error('Error updating favorite:', error);
                }
            }

            function checkAuthStatus() {
                const token = localStorage.getItem('authToken');
                return !!token;
            }

            // Check URL parameters for initial search
            const urlParams = new URLSearchParams(window.location.search);
            
            // Handle featured and recommended parameters
            if (urlParams.has('featured') && urlParams.get('featured') === 'true') {
                document.getElementById('searchType').value = '';
                document.getElementById('searchKeyword').value = 'Bất động sản nổi bật';
                // Set promotion filter
                setTimeout(() => performSearch(), 1000);
                return;
            }
            
            if (urlParams.has('recommended') && urlParams.get('recommended') === 'true') {
                document.getElementById('searchType').value = '';
                document.getElementById('searchKeyword').value = 'Bất động sản dành cho bạn';
                // Set non-promotion filter
                setTimeout(() => performSearch(), 1000);
                return;
            }
            
            if (urlParams.has('type') || urlParams.has('province') || urlParams.has('keyword') ||
                urlParams.has('minRoom') || urlParams.has('maxRoom') || urlParams.has('minPrice') ||
                urlParams.has('maxPrice') || urlParams.has('minArea') || urlParams.has('maxArea')) {

                if (urlParams.has('type') && urlParams.get('type').trim() !== '') {
                    const typeElement = document.getElementById('searchType');
                    if (typeElement) typeElement.value = urlParams.get('type');
                }

                if (urlParams.has('province')) {
                    const provinceElement = document.getElementById('searchProvince');
                    if (provinceElement) {
                        provinceElement.value = urlParams.get('province');
                        loadWards(urlParams.get('province'));
                    }
                }

                if (urlParams.has('keyword')) {
                    const keywordElement = document.getElementById('searchKeyword');
                    if (keywordElement) keywordElement.value = urlParams.get('keyword');
                }

                if (urlParams.has('minRoom')) {
                    const minRoomElement = document.getElementById('minRoom');
                    if (minRoomElement) {
                        minRoomElement.value = urlParams.get('minRoom');
                        document.getElementById('minRoomValue').textContent = urlParams.get('minRoom');
                    }
                }

                if (urlParams.has('maxRoom')) {
                    const maxRoomElement = document.getElementById('maxRoom');
                    if (maxRoomElement) {
                        maxRoomElement.value = urlParams.get('maxRoom');
                        document.getElementById('maxRoomValue').textContent = urlParams.get('maxRoom');
                    }
                }

                if (urlParams.has('minPrice')) {
                    const minPriceElement = document.getElementById('minPrice');
                    if (minPriceElement) {
                        minPriceElement.value = urlParams.get('minPrice');
                        document.getElementById('minPriceValue').textContent = `${urlParams.get('minPrice')} triệu`;
                    }
                }

                if (urlParams.has('maxPrice')) {
                    const maxPriceElement = document.getElementById('maxPrice');
                    if (maxPriceElement) {
                        maxPriceElement.value = urlParams.get('maxPrice');
                        document.getElementById('maxPriceValue').textContent = `${urlParams.get('maxPrice')} triệu`;
                    }
                }

                if (urlParams.has('minArea')) {
                    const minAreaElement = document.getElementById('minArea');
                    if (minAreaElement) {
                        minAreaElement.value = urlParams.get('minArea');
                        document.getElementById('minAreaValue').textContent = `${urlParams.get('minArea')} m²`;
                    }
                }

                if (urlParams.has('maxArea')) {
                    const maxAreaElement = document.getElementById('maxArea');
                    if (maxAreaElement) {
                        maxAreaElement.value = urlParams.get('maxArea');
                        document.getElementById('maxAreaValue').textContent = `${urlParams.get('maxArea')} m²`;
                    }
                }

                // Update filled tracks
                ['price', 'area', 'room'].forEach(prefix => {
                    const minInput = document.getElementById(`min${prefix.charAt(0).toUpperCase() + prefix.slice(1)}`);
                    const maxInput = document.getElementById(`max${prefix.charAt(0).toUpperCase() + prefix.slice(1)}`);
                    const filledTrack = document.getElementById(`${prefix}RangeFilled`);
                    const slider = {
                        minId: minInput.id,
                        maxId: maxInput.id,
                        filledId: filledTrack.id,
                        min: parseFloat(minInput.min),
                        max: parseFloat(maxInput.max)
                    };
                    const minValue = parseFloat(minInput.value);
                    const maxValue = parseFloat(maxInput.value);
                    const range = slider.max - slider.min;
                    const leftPercent = ((minValue - slider.min) / range) * 100;
                    const rightPercent = ((maxValue - slider.min) / range) * 100;
                    filledTrack.style.left = `${leftPercent}%`;
                    filledTrack.style.width = `${rightPercent - leftPercent}%`;
                });

                setTimeout(() => performSearch(), 1000);
            } else {
                const searchFilterData = sessionStorage.getItem('searchFilterData');
                if (searchFilterData) {
                    try {
                        const filterData = JSON.parse(searchFilterData);

                        if (filterData.type && filterData.type.trim() !== '') {
                            const typeElement = document.getElementById('searchType');
                            if (typeElement) typeElement.value = filterData.type;
                        }

                        if (filterData.province) {
                            const provinceElement = document.getElementById('searchProvince');
                            if (provinceElement) {
                                provinceElement.value = filterData.province;
                                loadWards(filterData.province);
                            }
                        }

                        if (filterData.keyword) {
                            const keywordElement = document.getElementById('searchKeyword');
                            if (keywordElement) keywordElement.value = filterData.keyword;
                        }

                        if (filterData.minRoom) {
                            const minRoomElement = document.getElementById('minRoom');
                            if (minRoomElement) {
                                minRoomElement.value = filterData.minRoom;
                                document.getElementById('minRoomValue').textContent = filterData.minRoom;
                            }
                        }

                        if (filterData.maxRoom) {
                            const maxRoomElement = document.getElementById('maxRoom');
                            if (maxRoomElement) {
                                maxRoomElement.value = filterData.maxRoom;
                                document.getElementById('maxRoomValue').textContent = filterData.maxRoom;
                            }
                        }

                        if (filterData.minPrice) {
                            const minPriceElement = document.getElementById('minPrice');
                            if (minPriceElement) {
                                minPriceElement.value = filterData.minPrice;
                                document.getElementById('minPriceValue').textContent = `${filterData.minPrice} triệu`;
                            }
                        }

                        if (filterData.maxPrice) {
                            const maxPriceElement = document.getElementById('maxPrice');
                            if (maxPriceElement) {
                                maxPriceElement.value = filterData.maxPrice;
                                document.getElementById('maxPriceValue').textContent = `${filterData.maxPrice} triệu`;
                            }
                        }

                        if (filterData.minArea) {
                            const minAreaElement = document.getElementById('minArea');
                            if (minAreaElement) {
                                minAreaElement.value = filterData.minArea;
                                document.getElementById('minAreaValue').textContent = `${filterData.minArea} m²`;
                            }
                        }

                        if (filterData.maxArea) {
                            const maxAreaElement = document.getElementById('maxArea');
                            if (maxAreaElement) {
                                maxAreaElement.value = filterData.maxArea;
                                document.getElementById('maxAreaValue').textContent = `${filterData.maxArea} m²`;
                            }
                        }

                        // Update filled tracks
                        ['price', 'area', 'room'].forEach(prefix => {
                            const minInput = document.getElementById(`min${prefix.charAt(0).toUpperCase() + prefix.slice(1)}`);
                            const maxInput = document.getElementById(`max${prefix.charAt(0).toUpperCase() + prefix.slice(1)}`);
                            const filledTrack = document.getElementById(`${prefix}RangeFilled`);
                            const slider = {
                                minId: minInput.id,
                                maxId: maxInput.id,
                                filledId: filledTrack.id,
                                min: parseFloat(minInput.min),
                                max: parseFloat(maxInput.max)
                            };
                            const minValue = parseFloat(minInput.value);
                            const maxValue = parseFloat(maxInput.value);
                            const range = slider.max - slider.min;
                            const leftPercent = ((minValue - slider.min) / range) * 100;
                            const rightPercent = ((maxValue - slider.min) / range) * 100;
                            filledTrack.style.left = `${leftPercent}%`;
                            filledTrack.style.width = `${rightPercent - leftPercent}%`;
                        });

                        setTimeout(() => performSearch(), 1000);
                        sessionStorage.removeItem('searchFilterData');
                    } catch (error) {
                        console.error('Error parsing search filter data:', error);
                    }
                }
            }
        });
    </script>
}
