@{
    Layout = "~/Views/Auth/_AuthLayout.cshtml";
    ViewBag.Title = "Đặt lại mật khẩu";
}

<div class="w-full p-10 bg-white/80 rounded-l-none rounded-3xl">
    <h2 class="text-lg text-gray-600">Đặt lại mật khẩu</h2>
    <h1 class="text-3xl font-bold mt-1 mb-6">Nhập mật khẩu mới</h1>

    <div class="mb-4 text-sm text-gray-600">
        Vui lòng nhập mật khẩu mới cho số điện thoại <span id="phoneNumber" class="font-semibold"></span>
    </div>

    <div id="successAlert" class="alert alert-success d-none mb-4" role="alert"></div>
    <div id="errorAlert" class="alert alert-danger d-none mb-4" role="alert"></div>

    <form id="resetPasswordForm">
        <div class="mb-4">
            <label class="block mb-2 text-sm font-medium text-gray-700" for="newPassword">Mật khẩu mới</label>
            <div class="relative">
                <input type="password" id="newPassword" name="newPassword"
                       placeholder="Nhập mật khẩu mới"
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm input-bootstrap"
                       required />
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer" id="toggleNewPassword">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <div class="text-xs text-gray-500 mt-1">Mật khẩu phải có ít nhất 6 ký tự</div>
        </div>

        <div class="mb-6">
            <label class="block mb-2 text-sm font-medium text-gray-700" for="confirmPassword">Xác nhận mật khẩu</label>
            <div class="relative">
                <input type="password" id="confirmPassword" name="confirmPassword"
                       placeholder="Nhập lại mật khẩu mới"
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm input-bootstrap"
                       required />
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer" id="toggleConfirmPassword">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
        </div>

        <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 rounded-full mb-6 transition">
            Đặt lại mật khẩu
        </button>

        <p class="text-sm text-center text-gray-600">
            <a href="/Auth/Login" class="text-orange-500 font-medium hover:underline">Quay lại đăng nhập</a>
        </p>
    </form>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Get phone number from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        let phone = urlParams.get('phone') || '';
        
        // Format phone number for display
        const displayPhone = phone.startsWith('0') ? phone : '0' + phone;
        document.getElementById('phoneNumber').textContent = displayPhone;

        // Toggle password visibility for new password
        document.getElementById('toggleNewPassword').addEventListener('click', function () {
            const passwordInput = document.getElementById('newPassword');
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        // Toggle password visibility for confirm password
        document.getElementById('toggleConfirmPassword').addEventListener('click', function () {
            const passwordInput = document.getElementById('confirmPassword');
            const icon = this.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        document.getElementById('resetPasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            
            // Hide previous alerts
            errorAlert.classList.add('d-none');
            successAlert.classList.add('d-none');
            
            // Validate password
            if (newPassword.length < 6) {
                showError('Mật khẩu phải có ít nhất 6 ký tự');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('Mật khẩu mới và xác nhận mật khẩu không khớp');
                return;
            }

            try {
                const response = await fetch('http://194.233.81.64:5000/api/Auth/reset-password-with-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phone,
                        otp: '', // OTP already verified in previous step
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                    // Redirect to login page after successful password reset
                    setTimeout(() => {
                        window.location.href = '/Auth/Login';
                    }, 3000);
                } else {
                    showError(result.message || 'Không thể đặt lại mật khẩu');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showError('Có lỗi xảy ra khi đặt lại mật khẩu');
            }
        });

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            successAlert.textContent = message;
            successAlert.classList.remove('d-none');
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
        }
    </script>
}
