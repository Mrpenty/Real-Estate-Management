@{
    Layout = "~/Views/Auth/_AuthLayout.cshtml";
    ViewBag.Title = "Quên mật khẩu";
}

<div class="w-full p-10 bg-white/80 rounded-l-none rounded-3xl">
    <h2 class="text-lg text-gray-600">Quên mật khẩu</h2>
    <h1 class="text-3xl font-bold mt-1 mb-6">Đặt lại mật khẩu</h1>

    <div class="mb-4 text-sm text-gray-600">
        Nhập số điện thoại của bạn để nhận mã OTP đặt lại mật khẩu
    </div>

    <div id="successAlert" class="alert alert-success d-none mb-4" role="alert"></div>
    <div id="errorAlert" class="alert alert-danger d-none mb-4" role="alert"></div>

    <form id="forgotPasswordForm">
        <div class="mb-4">
            <label class="block mb-2 text-sm font-medium text-gray-700" for="phoneNumber">Số điện thoại</label>
            <input type="tel" id="phoneNumber" name="phoneNumber"
                   placeholder="Nhập số điện thoại"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm input-bootstrap"
                   required />
            <div class="text-xs text-gray-500 mt-1">Vui lòng nhập số điện thoại đã đăng ký</div>
        </div>

        <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 rounded-full mb-6 transition">
            Gửi mã OTP
        </button>
    </form>

    <div class="text-center">
        <a href="/Auth/Login" class="text-orange-500 font-medium hover:underline">Quay lại đăng nhập</a>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.getElementById('phoneNumber').addEventListener('input', function (e) {
            let value = e.target.value.trim();
            // Remove any non-digit characters
            value = value.replace(/[^\d]/g, '');
            if (value.length > 11) {
                value = value.substring(0, 11);
            }
            e.target.value = value;
        });

        document.getElementById('forgotPasswordForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const errorAlert = document.getElementById('errorAlert');
            const successAlert = document.getElementById('successAlert');
            
            // Hide previous alerts
            errorAlert.classList.add('d-none');
            successAlert.classList.add('d-none');
            
            // Validate phone number format
            if (!/^(0\d{9,10})$/.test(phoneNumber)) {
                showError('Số điện thoại phải bắt đầu bằng 0 và có 10 hoặc 11 chữ số');
                return;
            }

            try {
                const response = await fetch('https://localhost:7031/api/Auth/forgot-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phoneNumber: phoneNumber })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccess(result.message);
                    // Redirect to OTP verification page
                    setTimeout(() => {
                        window.location.href = `/Auth/VerifyOTPForPasswordReset?phone=${encodeURIComponent(phoneNumber)}`;
                    }, 2000);
                } else {
                    showError(result.message || 'Không thể gửi mã OTP');
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                showError('Có lỗi xảy ra khi gửi mã OTP');
            }
        });

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            successAlert.textContent = message;
            successAlert.classList.remove('d-none');
        }

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
        }
    </script>
}
